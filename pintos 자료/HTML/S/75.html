<html>
<head>
<title>src/userprog/pagedir.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/595.html'>src</a>/<a href='../files/612.html'>userprog</a>/pagedir.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L17'>[^]</a><a href='#L255'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L17' title='Defined at 17.'>pagedir_create</a>
<li><a href='#L28' title='Defined at 28.'>pagedir_destroy</a>
<li><a href='#L57' title='Defined at 57.'>lookup_page</a>
<li><a href='#L99' title='Defined at 99.'>pagedir_set_page</a>
<li><a href='#L126' title='Defined at 126.'>pagedir_get_page</a>
<li><a href='#L144' title='Defined at 144.'>pagedir_clear_page</a>
<li><a href='#L164' title='Defined at 164.'>pagedir_is_dirty</a>
<li><a href='#L173' title='Defined at 173.'>pagedir_set_dirty</a>
<li><a href='#L193' title='Defined at 193.'>pagedir_is_accessed</a>
<li><a href='#L202' title='Defined at 202.'>pagedir_set_accessed</a>
<li><a href='#L220' title='Defined at 220.'>pagedir_activate</a>
<li><a href='#L235' title='Defined at 235.'>active_pd</a>
<li><a href='#L255' title='Defined at 255.'>invalidate_pagedir</a>
</ol>
<hr>
<pre>
<a name='L1'>   1 <font color='darkred'>#include</font> "<a href='73.html'>userprog/pagedir.h</a>"
<a name='L2'>   2 <font color='darkred'>#include</font> &lt;<a href='78.html'>stdbool.h</a>&gt;
<a name='L3'>   3 <font color='darkred'>#include</font> &lt;<a href='92.html'>stddef.h</a>&gt;
<a name='L4'>   4 <font color='darkred'>#include</font> &lt;<a href='82.html'>string.h</a>&gt;
<a name='L5'>   5 <font color='darkred'>#include</font> "<a href='144.html'>threads/init.h</a>"
<a name='L6'>   6 <font color='darkred'>#include</font> "<a href='162.html'>threads/pte.h</a>"
<a name='L7'>   7 <font color='darkred'>#include</font> "<a href='165.html'>threads/palloc.h</a>"
<a name='L8'>   8 
<a name='L9'>   9 <b>static</b> <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *<a href='../S/75.html#L235' title='Defined at 235 in src/userprog/pagedir.c.'>active_pd</a> (<b>void</b>);
<a name='L10'>  10 <b>static</b> <b>void</b> <a href='../S/75.html#L255' title='Defined at 255 in src/userprog/pagedir.c.'>invalidate_pagedir</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *);
<a name='L11'>  11 
<a name='L12'>  12 <i><font color='green'>/* Creates a new page directory that has mappings for kernel</font></i>
<a name='L13'>  13 <i><font color='green'>   virtual addresses, but none for user virtual addresses.</font></i>
<a name='L14'>  14 <i><font color='green'>   Returns the new page directory, or a null pointer if memory</font></i>
<a name='L15'>  15 <i><font color='green'>   allocation fails. */</font></i>
<a name='L16'>  16 <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *
<a name='L17'>  17 <a href='../R/684.html' title='Multiple refered from 2 places.'>pagedir_create</a> (<b>void</b>) 
<a name='L18'>  18 <font color='red'>{</font>
<a name='L19'>  19   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd = <a href='../S/160.html#L111' title='Defined at 111 in src/threads/palloc.c.'>palloc_get_page</a> (0);
<a name='L20'>  20   <b>if</b> (pd != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>)
<a name='L21'>  21     <a href='../S/83.html#L7' title='Defined at 7 in src/lib/string.c.'>memcpy</a> (pd, init_page_dir, <a href='../S/153.html#L20' title='Defined at 20 in src/threads/vaddr.h.'>PGSIZE</a>);
<a name='L22'>  22   <b>return</b> pd;
<a name='L23'>  23 <font color='red'>}</font>
<a name='L24'>  24 
<a name='L25'>  25 <i><font color='green'>/* Destroys page directory PD, freeing all the pages it</font></i>
<a name='L26'>  26 <i><font color='green'>   references. */</font></i>
<a name='L27'>  27 <b>void</b>
<a name='L28'>  28 <a href='../R/685.html' title='Multiple refered from 2 places.'>pagedir_destroy</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd) 
<a name='L29'>  29 <font color='red'>{</font>
<a name='L30'>  30   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pde;
<a name='L31'>  31 
<a name='L32'>  32   <b>if</b> (pd == <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>)
<a name='L33'>  33     <b>return</b>;
<a name='L34'>  34 
<a name='L35'>  35   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (pd != init_page_dir);
<a name='L36'>  36   <b>for</b> (pde = pd; pde &lt; pd + <a href='../S/162.html#L37' title='Defined at 37 in src/threads/pte.h.'>pd_no</a> (<a href='../S/153.html#L53' title='Defined at 53 in src/threads/vaddr.h.'>PHYS_BASE</a>); pde++)
<a name='L37'>  37     <b>if</b> (*pde &amp; <a href='../S/162.html#L64' title='Defined at 64 in src/threads/pte.h.'>PTE_P</a>) 
<a name='L38'>  38       <font color='red'>{</font>
<a name='L39'>  39         <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pt = <a href='../S/162.html#L78' title='Defined at 78 in src/threads/pte.h.'>pde_get_pt</a> (*pde);
<a name='L40'>  40         <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte;
<a name='L41'>  41         
<a name='L42'>  42         <b>for</b> (pte = pt; pte &lt; pt + <a href='../S/153.html#L20' title='Defined at 20 in src/threads/vaddr.h.'>PGSIZE</a> / <b>sizeof</b> *pte; pte++)
<a name='L43'>  43           <b>if</b> (*pte &amp; <a href='../S/162.html#L64' title='Defined at 64 in src/threads/pte.h.'>PTE_P</a>) 
<a name='L44'>  44             <a href='../S/160.html#L146' title='Defined at 146 in src/threads/palloc.c.'>palloc_free_page</a> (<a href='../S/162.html#L102' title='Defined at 102 in src/threads/pte.h.'>pte_get_page</a> (*pte));
<a name='L45'>  45         <a href='../S/160.html#L146' title='Defined at 146 in src/threads/palloc.c.'>palloc_free_page</a> (pt);
<a name='L46'>  46       <font color='red'>}</font>
<a name='L47'>  47   <a href='../S/160.html#L146' title='Defined at 146 in src/threads/palloc.c.'>palloc_free_page</a> (pd);
<a name='L48'>  48 <font color='red'>}</font>
<a name='L49'>  49 
<a name='L50'>  50 <i><font color='green'>/* Returns the address of the page table entry for virtual</font></i>
<a name='L51'>  51 <i><font color='green'>   address VADDR in page directory PD.</font></i>
<a name='L52'>  52 <i><font color='green'>   If PD does not have a page table for VADDR, behavior depends</font></i>
<a name='L53'>  53 <i><font color='green'>   on CREATE.  If CREATE is true, then a new page table is</font></i>
<a name='L54'>  54 <i><font color='green'>   created and a pointer into it is returned.  Otherwise, a null</font></i>
<a name='L55'>  55 <i><font color='green'>   pointer is returned. */</font></i>
<a name='L56'>  56 <b>static</b> <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *
<a name='L57'>  57 <a href='../R/637.html' title='Multiple refered from 7 places.'>lookup_page</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>const</b> <b>void</b> *vaddr, bool create)
<a name='L58'>  58 <font color='red'>{</font>
<a name='L59'>  59   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pt, *pde;
<a name='L60'>  60 
<a name='L61'>  61   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (pd != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L62'>  62 
<a name='L63'>  63   <i><font color='green'>/* Shouldn't create new kernel virtual mappings. */</font></i>
<a name='L64'>  64   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (!<a href='../S/97.html#L91' title='Defined at 91 in src/lib/user/syscall.c.'>create</a> || <a href='../S/153.html#L57' title='Defined at 57 in src/threads/vaddr.h.'>is_user_vaddr</a> (vaddr));
<a name='L65'>  65 
<a name='L66'>  66   <i><font color='green'>/* Check for a page table for VADDR.</font></i>
<a name='L67'>  67 <i><font color='green'>     If one is missing, create one if requested. */</font></i>
<a name='L68'>  68   pde = pd + <a href='../S/162.html#L37' title='Defined at 37 in src/threads/pte.h.'>pd_no</a> (vaddr);
<a name='L69'>  69   <b>if</b> (*pde == 0) 
<a name='L70'>  70     <font color='red'>{</font>
<a name='L71'>  71       <b>if</b> (<a href='../S/97.html#L91' title='Defined at 91 in src/lib/user/syscall.c.'>create</a>)
<a name='L72'>  72         <font color='red'>{</font>
<a name='L73'>  73           pt = <a href='../S/160.html#L111' title='Defined at 111 in src/threads/palloc.c.'>palloc_get_page</a> (PAL_ZERO);
<a name='L74'>  74           <b>if</b> (pt == <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>) 
<a name='L75'>  75             <b>return</b> <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>; 
<a name='L76'>  76       
<a name='L77'>  77           *pde = <a href='../S/162.html#L71' title='Defined at 71 in src/threads/pte.h.'>pde_create</a> (pt);
<a name='L78'>  78         <font color='red'>}</font>
<a name='L79'>  79       <b>else</b>
<a name='L80'>  80         <b>return</b> <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>;
<a name='L81'>  81     <font color='red'>}</font>
<a name='L82'>  82 
<a name='L83'>  83   <i><font color='green'>/* Return the page table entry. */</font></i>
<a name='L84'>  84   pt = <a href='../S/162.html#L78' title='Defined at 78 in src/threads/pte.h.'>pde_get_pt</a> (*pde);
<a name='L85'>  85   <b>return</b> &amp;pt[<a href='../S/162.html#L32' title='Defined at 32 in src/threads/pte.h.'>pt_no</a> (vaddr)];
<a name='L86'>  86 <font color='red'>}</font>
<a name='L87'>  87 
<a name='L88'>  88 <i><font color='green'>/* Adds a mapping in page directory PD from user virtual page</font></i>
<a name='L89'>  89 <i><font color='green'>   UPAGE to the physical frame identified by kernel virtual</font></i>
<a name='L90'>  90 <i><font color='green'>   address KPAGE.</font></i>
<a name='L91'>  91 <i><font color='green'>   UPAGE must not already be mapped.</font></i>
<a name='L92'>  92 <i><font color='green'>   KPAGE should probably be a page obtained from the user pool</font></i>
<a name='L93'>  93 <i><font color='green'>   with palloc_get_page().</font></i>
<a name='L94'>  94 <i><font color='green'>   If WRITABLE is true, the new page is read/write;</font></i>
<a name='L95'>  95 <i><font color='green'>   otherwise it is read-only.</font></i>
<a name='L96'>  96 <i><font color='green'>   Returns true if successful, false if memory allocation</font></i>
<a name='L97'>  97 <i><font color='green'>   failed. */</font></i>
<a name='L98'>  98 <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a>
<a name='L99'>  99 <a href='../R/691.html' title='Multiple refered from 2 places.'>pagedir_set_page</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>void</b> *upage, <b>void</b> *kpage, bool writable)
<a name='L100'> 100 <font color='red'>{</font>
<a name='L101'> 101   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte;
<a name='L102'> 102 
<a name='L103'> 103   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L24' title='Defined at 24 in src/threads/vaddr.h.'>pg_ofs</a> (upage) == 0);
<a name='L104'> 104   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L24' title='Defined at 24 in src/threads/vaddr.h.'>pg_ofs</a> (kpage) == 0);
<a name='L105'> 105   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L57' title='Defined at 57 in src/threads/vaddr.h.'>is_user_vaddr</a> (upage));
<a name='L106'> 106   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L82' title='Defined at 82 in src/threads/vaddr.h.'>vtop</a> (kpage) &gt;&gt; <a href='../S/162.html#L21' title='Defined at 21 in src/threads/pte.h.'>PTSHIFT</a> &lt; init_ram_pages);
<a name='L107'> 107   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (pd != init_page_dir);
<a name='L108'> 108 
<a name='L109'> 109   pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, upage, <a href='../S/78.html#L5' title='Defined at 5 in src/lib/stdbool.h.'>true</a>);
<a name='L110'> 110 
<a name='L111'> 111   <b>if</b> (pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>) 
<a name='L112'> 112     <font color='red'>{</font>
<a name='L113'> 113       <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> ((*pte &amp; <a href='../S/162.html#L64' title='Defined at 64 in src/threads/pte.h.'>PTE_P</a>) == 0);
<a name='L114'> 114       *pte = <a href='../S/162.html#L96' title='Defined at 96 in src/threads/pte.h.'>pte_create_user</a> (kpage, writable);
<a name='L115'> 115       <b>return</b> <a href='../S/78.html#L5' title='Defined at 5 in src/lib/stdbool.h.'>true</a>;
<a name='L116'> 116     <font color='red'>}</font>
<a name='L117'> 117   <b>else</b>
<a name='L118'> 118     <b>return</b> <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>;
<a name='L119'> 119 <font color='red'>}</font>
<a name='L120'> 120 
<a name='L121'> 121 <i><font color='green'>/* Looks up the physical address that corresponds to user virtual</font></i>
<a name='L122'> 122 <i><font color='green'>   address UADDR in PD.  Returns the kernel virtual address</font></i>
<a name='L123'> 123 <i><font color='green'>   corresponding to that physical address, or a null pointer if</font></i>
<a name='L124'> 124 <i><font color='green'>   UADDR is unmapped. */</font></i>
<a name='L125'> 125 <b>void</b> *
<a name='L126'> 126 <a href='../R/686.html' title='Multiple refered from 2 places.'>pagedir_get_page</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>const</b> <b>void</b> *uaddr) 
<a name='L127'> 127 <font color='red'>{</font>
<a name='L128'> 128   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte;
<a name='L129'> 129 
<a name='L130'> 130   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L57' title='Defined at 57 in src/threads/vaddr.h.'>is_user_vaddr</a> (uaddr));
<a name='L131'> 131   
<a name='L132'> 132   pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, uaddr, <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>);
<a name='L133'> 133   <b>if</b> (pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a> &amp;&amp; (*pte &amp; <a href='../S/162.html#L64' title='Defined at 64 in src/threads/pte.h.'>PTE_P</a>) != 0)
<a name='L134'> 134     <b>return</b> <a href='../S/162.html#L102' title='Defined at 102 in src/threads/pte.h.'>pte_get_page</a> (*pte) + <a href='../S/153.html#L24' title='Defined at 24 in src/threads/vaddr.h.'>pg_ofs</a> (uaddr);
<a name='L135'> 135   <b>else</b>
<a name='L136'> 136     <b>return</b> <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>;
<a name='L137'> 137 <font color='red'>}</font>
<a name='L138'> 138 
<a name='L139'> 139 <i><font color='green'>/* Marks user virtual page UPAGE "not present" in page</font></i>
<a name='L140'> 140 <i><font color='green'>   directory PD.  Later accesses to the page will fault.  Other</font></i>
<a name='L141'> 141 <i><font color='green'>   bits in the page table entry are preserved.</font></i>
<a name='L142'> 142 <i><font color='green'>   UPAGE need not be mapped. */</font></i>
<a name='L143'> 143 <b>void</b>
<a name='L144'> 144 <a href='../S/73.html#L11' title='Refered from 11 in src/userprog/pagedir.h.'>pagedir_clear_page</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>void</b> *upage) 
<a name='L145'> 145 <font color='red'>{</font>
<a name='L146'> 146   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte;
<a name='L147'> 147 
<a name='L148'> 148   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L24' title='Defined at 24 in src/threads/vaddr.h.'>pg_ofs</a> (upage) == 0);
<a name='L149'> 149   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/153.html#L57' title='Defined at 57 in src/threads/vaddr.h.'>is_user_vaddr</a> (upage));
<a name='L150'> 150 
<a name='L151'> 151   pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, upage, <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>);
<a name='L152'> 152   <b>if</b> (pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a> &amp;&amp; (*pte &amp; <a href='../S/162.html#L64' title='Defined at 64 in src/threads/pte.h.'>PTE_P</a>) != 0)
<a name='L153'> 153     <font color='red'>{</font>
<a name='L154'> 154       *pte &amp;= ~<a href='../S/162.html#L64' title='Defined at 64 in src/threads/pte.h.'>PTE_P</a>;
<a name='L155'> 155       <a href='../S/75.html#L255' title='Defined at 255 in src/userprog/pagedir.c.'>invalidate_pagedir</a> (pd);
<a name='L156'> 156     <font color='red'>}</font>
<a name='L157'> 157 <font color='red'>}</font>
<a name='L158'> 158 
<a name='L159'> 159 <i><font color='green'>/* Returns true if the PTE for virtual page VPAGE in PD is dirty,</font></i>
<a name='L160'> 160 <i><font color='green'>   that is, if the page has been modified since the PTE was</font></i>
<a name='L161'> 161 <i><font color='green'>   installed.</font></i>
<a name='L162'> 162 <i><font color='green'>   Returns false if PD contains no PTE for VPAGE. */</font></i>
<a name='L163'> 163 <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a>
<a name='L164'> 164 <a href='../S/73.html#L12' title='Refered from 12 in src/userprog/pagedir.h.'>pagedir_is_dirty</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>const</b> <b>void</b> *vpage) 
<a name='L165'> 165 <font color='red'>{</font>
<a name='L166'> 166   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, vpage, <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>);
<a name='L167'> 167   <b>return</b> pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a> &amp;&amp; (*pte &amp; <a href='../S/162.html#L68' title='Defined at 68 in src/threads/pte.h.'>PTE_D</a>) != 0;
<a name='L168'> 168 <font color='red'>}</font>
<a name='L169'> 169 
<a name='L170'> 170 <i><font color='green'>/* Set the dirty bit to DIRTY in the PTE for virtual page VPAGE</font></i>
<a name='L171'> 171 <i><font color='green'>   in PD. */</font></i>
<a name='L172'> 172 <b>void</b>
<a name='L173'> 173 <a href='../S/73.html#L13' title='Refered from 13 in src/userprog/pagedir.h.'>pagedir_set_dirty</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>const</b> <b>void</b> *vpage, bool dirty) 
<a name='L174'> 174 <font color='red'>{</font>
<a name='L175'> 175   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, vpage, <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>);
<a name='L176'> 176   <b>if</b> (pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>) 
<a name='L177'> 177     <font color='red'>{</font>
<a name='L178'> 178       <b>if</b> (dirty)
<a name='L179'> 179         *pte |= <a href='../S/162.html#L68' title='Defined at 68 in src/threads/pte.h.'>PTE_D</a>;
<a name='L180'> 180       <b>else</b> 
<a name='L181'> 181         <font color='red'>{</font>
<a name='L182'> 182           *pte &amp;= ~(<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) <a href='../S/162.html#L68' title='Defined at 68 in src/threads/pte.h.'>PTE_D</a>;
<a name='L183'> 183           <a href='../S/75.html#L255' title='Defined at 255 in src/userprog/pagedir.c.'>invalidate_pagedir</a> (pd);
<a name='L184'> 184         <font color='red'>}</font>
<a name='L185'> 185     <font color='red'>}</font>
<a name='L186'> 186 <font color='red'>}</font>
<a name='L187'> 187 
<a name='L188'> 188 <i><font color='green'>/* Returns true if the PTE for virtual page VPAGE in PD has been</font></i>
<a name='L189'> 189 <i><font color='green'>   accessed recently, that is, between the time the PTE was</font></i>
<a name='L190'> 190 <i><font color='green'>   installed and the last time it was cleared.  Returns false if</font></i>
<a name='L191'> 191 <i><font color='green'>   PD contains no PTE for VPAGE. */</font></i>
<a name='L192'> 192 <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a>
<a name='L193'> 193 <a href='../S/73.html#L14' title='Refered from 14 in src/userprog/pagedir.h.'>pagedir_is_accessed</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>const</b> <b>void</b> *vpage) 
<a name='L194'> 194 <font color='red'>{</font>
<a name='L195'> 195   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, vpage, <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>);
<a name='L196'> 196   <b>return</b> pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a> &amp;&amp; (*pte &amp; <a href='../S/162.html#L67' title='Defined at 67 in src/threads/pte.h.'>PTE_A</a>) != 0;
<a name='L197'> 197 <font color='red'>}</font>
<a name='L198'> 198 
<a name='L199'> 199 <i><font color='green'>/* Sets the accessed bit to ACCESSED in the PTE for virtual page</font></i>
<a name='L200'> 200 <i><font color='green'>   VPAGE in PD. */</font></i>
<a name='L201'> 201 <b>void</b>
<a name='L202'> 202 <a href='../S/73.html#L15' title='Refered from 15 in src/userprog/pagedir.h.'>pagedir_set_accessed</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd, <b>const</b> <b>void</b> *vpage, bool accessed) 
<a name='L203'> 203 <font color='red'>{</font>
<a name='L204'> 204   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pte = <a href='../S/75.html#L57' title='Defined at 57 in src/userprog/pagedir.c.'>lookup_page</a> (pd, vpage, <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>);
<a name='L205'> 205   <b>if</b> (pte != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>) 
<a name='L206'> 206     <font color='red'>{</font>
<a name='L207'> 207       <b>if</b> (accessed)
<a name='L208'> 208         *pte |= <a href='../S/162.html#L67' title='Defined at 67 in src/threads/pte.h.'>PTE_A</a>;
<a name='L209'> 209       <b>else</b> 
<a name='L210'> 210         <font color='red'>{</font>
<a name='L211'> 211           *pte &amp;= ~(<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) <a href='../S/162.html#L67' title='Defined at 67 in src/threads/pte.h.'>PTE_A</a>; 
<a name='L212'> 212           <a href='../S/75.html#L255' title='Defined at 255 in src/userprog/pagedir.c.'>invalidate_pagedir</a> (pd);
<a name='L213'> 213         <font color='red'>}</font>
<a name='L214'> 214     <font color='red'>}</font>
<a name='L215'> 215 <font color='red'>}</font>
<a name='L216'> 216 
<a name='L217'> 217 <i><font color='green'>/* Loads page directory PD into the CPU's page directory base</font></i>
<a name='L218'> 218 <i><font color='green'>   register. */</font></i>
<a name='L219'> 219 <b>void</b>
<a name='L220'> 220 <a href='../R/682.html' title='Multiple refered from 4 places.'>pagedir_activate</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd) 
<a name='L221'> 221 <font color='red'>{</font>
<a name='L222'> 222   <b>if</b> (pd == <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>)
<a name='L223'> 223     pd = init_page_dir;
<a name='L224'> 224 
<a name='L225'> 225   <i><font color='green'>/* Store the physical address of the page directory into CR3</font></i>
<a name='L226'> 226 <i><font color='green'>     aka PDBR (page directory base register).  This activates our</font></i>
<a name='L227'> 227 <i><font color='green'>     new page tables immediately.  See [IA32-v2a] "MOV--Move</font></i>
<a name='L228'> 228 <i><font color='green'>     to/from Control Registers" and [IA32-v3a] 3.7.5 "Base</font></i>
<a name='L229'> 229 <i><font color='green'>     Address of the Page Directory". */</font></i>
<a name='L230'> 230   <b>asm</b> <b>volatile</b> ("movl %0, %%cr3" : : "r" (<a href='../S/153.html#L82' title='Defined at 82 in src/threads/vaddr.h.'>vtop</a> (pd)) : "memory");
<a name='L231'> 231 <font color='red'>}</font>
<a name='L232'> 232 
<a name='L233'> 233 <i><font color='green'>/* Returns the currently active page directory. */</font></i>
<a name='L234'> 234 <b>static</b> <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *
<a name='L235'> 235 <a href='../R/286.html' title='Multiple refered from 2 places.'>active_pd</a> (<b>void</b>) 
<a name='L236'> 236 <font color='red'>{</font>
<a name='L237'> 237   <i><font color='green'>/* Copy CR3, the page directory base register (PDBR), into</font></i>
<a name='L238'> 238 <i><font color='green'>     `pd'.</font></i>
<a name='L239'> 239 <i><font color='green'>     See [IA32-v2a] "MOV--Move to/from Control Registers" and</font></i>
<a name='L240'> 240 <i><font color='green'>     [IA32-v3a] 3.7.5 "Base Address of the Page Directory". */</font></i>
<a name='L241'> 241   <a href='../S/87.html#L36' title='Defined at 36 in src/lib/stdint.h.'>uintptr_t</a> pd;
<a name='L242'> 242   <b>asm</b> <b>volatile</b> ("movl %%cr3, %0" : "=r" (pd));
<a name='L243'> 243   <b>return</b> <a href='../S/153.html#L72' title='Defined at 72 in src/threads/vaddr.h.'>ptov</a> (pd);
<a name='L244'> 244 <font color='red'>}</font>
<a name='L245'> 245 
<a name='L246'> 246 <i><font color='green'>/* Seom page table changes can cause the CPU's translation</font></i>
<a name='L247'> 247 <i><font color='green'>   lookaside buffer (TLB) to become out-of-sync with the page</font></i>
<a name='L248'> 248 <i><font color='green'>   table.  When this happens, we have to "invalidate" the TLB by</font></i>
<a name='L249'> 249 <i><font color='green'>   re-activating it.</font></i>
<a name='L250'> 250 <i><font color='green'></font></i>
<a name='L251'> 251 <i><font color='green'>   This function invalidates the TLB if PD is the active page</font></i>
<a name='L252'> 252 <i><font color='green'>   directory.  (If PD is not active then its entries are not in</font></i>
<a name='L253'> 253 <i><font color='green'>   the TLB, so there is no need to invalidate anything.) */</font></i>
<a name='L254'> 254 <b>static</b> <b>void</b>
<a name='L255'> 255 <a href='../R/561.html' title='Multiple refered from 4 places.'>invalidate_pagedir</a> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *pd) 
<a name='L256'> 256 <font color='red'>{</font>
<a name='L257'> 257   <b>if</b> (<a href='../S/75.html#L235' title='Defined at 235 in src/userprog/pagedir.c.'>active_pd</a> () == pd) 
<a name='L258'> 258     <font color='red'>{</font>
<a name='L259'> 259       <i><font color='green'>/* Re-activating PD clears the TLB.  See [IA32-v3a] 3.12</font></i>
<a name='L260'> 260 <i><font color='green'>         "Translation Lookaside Buffers (TLBs)". */</font></i>
<a name='L261'> 261       <a href='../S/75.html#L220' title='Defined at 220 in src/userprog/pagedir.c.'>pagedir_activate</a> (pd);
<a name='L262'> 262     <font color='red'>}</font> 
<a name='L263'> 263 <font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L17'>[^]</a><a href='#L255'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
