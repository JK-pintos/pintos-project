<html>
<head>
<title>src/threads/interrupt.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/595.html'>src</a>/<a href='../files/611.html'>threads</a>/interrupt.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L65'>[^]</a><a href='#L435'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L65' title='Defined at 65.'>intr_get_level</a>
<li><a href='#L81' title='Defined at 81.'>intr_set_level</a>
<li><a href='#L88' title='Defined at 88.'>intr_enable</a>
<li><a href='#L104' title='Defined at 104.'>intr_disable</a>
<li><a href='#L118' title='Defined at 118.'>intr_init</a>
<li><a href='#L165' title='Defined at 165.'>register_handler</a>
<li><a href='#L181' title='Defined at 181.'>intr_register_ext</a>
<li><a href='#L202' title='Defined at 202.'>intr_register_int</a>
<li><a href='#L212' title='Defined at 212.'>intr_context</a>
<li><a href='#L222' title='Defined at 222.'>intr_yield_on_return</a>
<li><a href='#L238' title='Defined at 238.'>pic_init</a>
<li><a href='#L265' title='Defined at 265.'>pic_end_of_interrupt</a>
<li><a href='#L294' title='Defined at 294.'>make_gate</a>
<li><a href='#L317' title='Defined at 317.'>make_intr_gate</a>
<li><a href='#L325' title='Defined at 325.'>make_trap_gate</a>
<li><a href='#L333' title='Defined at 333.'>make_idtr_operand</a>
<li><a href='#L345' title='Defined at 345.'>intr_handler</a>
<li><a href='#L394' title='Defined at 394.'>unexpected_interrupt</a>
<li><a href='#L411' title='Defined at 411.'>intr_dump_frame</a>
<li><a href='#L435' title='Defined at 435.'>intr_name</a>
</ol>
<hr>
<pre>
<a name='L1'>   1 <font color='darkred'>#include</font> "<a href='150.html'>threads/interrupt.h</a>"
<a name='L2'>   2 <font color='darkred'>#include</font> &lt;<a href='104.html'>debug.h</a>&gt;
<a name='L3'>   3 <font color='darkred'>#include</font> &lt;<a href='81.html'>inttypes.h</a>&gt;
<a name='L4'>   4 <font color='darkred'>#include</font> &lt;<a href='87.html'>stdint.h</a>&gt;
<a name='L5'>   5 <font color='darkred'>#include</font> &lt;<a href='../I/72.html'>stdio.h</a>&gt;
<a name='L6'>   6 <font color='darkred'>#include</font> "<a href='145.html'>threads/flags.h</a>"
<a name='L7'>   7 <font color='darkred'>#include</font> "<a href='166.html'>threads/intr-stubs.h</a>"
<a name='L8'>   8 <font color='darkred'>#include</font> "<a href='157.html'>threads/io.h</a>"
<a name='L9'>   9 <font color='darkred'>#include</font> "<a href='164.html'>threads/thread.h</a>"
<a name='L10'>  10 <font color='darkred'>#include</font> "<a href='153.html'>threads/vaddr.h</a>"
<a name='L11'>  11 <font color='darkred'>#include</font> "<a href='124.html'>devices/timer.h</a>"
<a name='L12'>  12 
<a name='L13'>  13 <i><font color='green'>/* Programmable Interrupt Controller (PIC) registers.</font></i>
<a name='L14'>  14 <i><font color='green'>   A PC has two PICs, called the master and slave PICs, with the</font></i>
<a name='L15'>  15 <i><font color='green'>   slave attached ("cascaded") to the master IRQ line 2. */</font></i>
<a name='L16'>  16 <font color='darkred'>#define</font> <a href='../S/168.html#L245' title='Refered from 245 in src/threads/interrupt.c.'>PIC0_CTRL</a>       0x20    <i><font color='green'>/* Master PIC control register address. */</font></i>
<a name='L17'>  17 <font color='darkred'>#define</font> <a href='../R/131.html' title='Multiple refered from 5 places.'>PIC0_DATA</a>       0x21    <i><font color='green'>/* Master PIC data register address. */</font></i>
<a name='L18'>  18 <font color='darkred'>#define</font> <a href='../S/168.html#L251' title='Refered from 251 in src/threads/interrupt.c.'>PIC1_CTRL</a>       0xa0    <i><font color='green'>/* Slave PIC control register address. */</font></i>
<a name='L19'>  19 <font color='darkred'>#define</font> <a href='../R/133.html' title='Multiple refered from 5 places.'>PIC1_DATA</a>       0xa1    <i><font color='green'>/* Slave PIC data register address. */</font></i>
<a name='L20'>  20 
<a name='L21'>  21 <i><font color='green'>/* Number of x86 interrupts. */</font></i>
<a name='L22'>  22 <font color='darkred'>#define</font> <a href='../R/78.html' title='Multiple refered from 6 places.'>INTR_CNT</a> 256
<a name='L23'>  23 
<a name='L24'>  24 <i><font color='green'>/* The Interrupt Descriptor Table (IDT).  The format is fixed by</font></i>
<a name='L25'>  25 <i><font color='green'>   the CPU.  See [IA32-v3a] sections 5.10 "Interrupt Descriptor</font></i>
<a name='L26'>  26 <i><font color='green'>   Table (IDT)", 5.11 "IDT Descriptors", 5.12.1.2 "Flag Usage By</font></i>
<a name='L27'>  27 <i><font color='green'>   Exception- or Interrupt-Handler Procedure". */</font></i>
<a name='L28'>  28 <b>static</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a> idt[<a href='../S/168.html#L22' title='Defined at 22 in src/threads/interrupt.c.'>INTR_CNT</a>];
<a name='L29'>  29 
<a name='L30'>  30 <i><font color='green'>/* Interrupt handler functions for each interrupt. */</font></i>
<a name='L31'>  31 <b>static</b> <a href='../S/150.html#L58' title='Defined at 58 in src/threads/interrupt.h.'>intr_handler_func</a> *intr_handlers[<a href='../S/168.html#L22' title='Defined at 22 in src/threads/interrupt.c.'>INTR_CNT</a>];
<a name='L32'>  32 
<a name='L33'>  33 <i><font color='green'>/* Names for each interrupt, for debugging purposes. */</font></i>
<a name='L34'>  34 <b>static</b> <b>const</b> <b>char</b> *intr_names[<a href='../S/168.html#L22' title='Defined at 22 in src/threads/interrupt.c.'>INTR_CNT</a>];
<a name='L35'>  35 
<a name='L36'>  36 <i><font color='green'>/* Number of unexpected interrupts for each vector.  An</font></i>
<a name='L37'>  37 <i><font color='green'>   unexpected interrupt is one that has no registered handler. */</font></i>
<a name='L38'>  38 <b>static</b> <b>unsigned</b> <b>int</b> unexpected_cnt[<a href='../S/168.html#L22' title='Defined at 22 in src/threads/interrupt.c.'>INTR_CNT</a>];
<a name='L39'>  39 
<a name='L40'>  40 <i><font color='green'>/* External interrupts are those generated by devices outside the</font></i>
<a name='L41'>  41 <i><font color='green'>   CPU, such as the timer.  External interrupts run with</font></i>
<a name='L42'>  42 <i><font color='green'>   interrupts turned off, so they never nest, nor are they ever</font></i>
<a name='L43'>  43 <i><font color='green'>   pre-empted.  Handlers for external interrupts also may not</font></i>
<a name='L44'>  44 <i><font color='green'>   sleep, although they may invoke intr_yield_on_return() to</font></i>
<a name='L45'>  45 <i><font color='green'>   request that a new process be scheduled just before the</font></i>
<a name='L46'>  46 <i><font color='green'>   interrupt returns. */</font></i>
<a name='L47'>  47 <b>static</b> <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a> in_external_intr;   <i><font color='green'>/* Are we processing an external interrupt? */</font></i>
<a name='L48'>  48 <b>static</b> <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a> yield_on_return;    <i><font color='green'>/* Should we yield on interrupt return? */</font></i>
<a name='L49'>  49 
<a name='L50'>  50 <i><font color='green'>/* Programmable Interrupt Controller helpers. */</font></i>
<a name='L51'>  51 <b>static</b> <b>void</b> <a href='../S/168.html#L238' title='Defined at 238 in src/threads/interrupt.c.'>pic_init</a> (<b>void</b>);
<a name='L52'>  52 <b>static</b> <b>void</b> <a href='../S/168.html#L265' title='Defined at 265 in src/threads/interrupt.c.'>pic_end_of_interrupt</a> (<b>int</b> irq);
<a name='L53'>  53 
<a name='L54'>  54 <i><font color='green'>/* Interrupt Descriptor Table helpers. */</font></i>
<a name='L55'>  55 <b>static</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a> <a href='../S/168.html#L317' title='Defined at 317 in src/threads/interrupt.c.'>make_intr_gate</a> (<b>void</b> (*) (<b>void</b>), <b>int</b> dpl);
<a name='L56'>  56 <b>static</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a> <a href='../S/168.html#L325' title='Defined at 325 in src/threads/interrupt.c.'>make_trap_gate</a> (<b>void</b> (*) (<b>void</b>), <b>int</b> dpl);
<a name='L57'>  57 <b>static</b> <b>inline</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a> <a href='../S/168.html#L333' title='Defined at 333 in src/threads/interrupt.c.'>make_idtr_operand</a> (<a href='../S/87.html#L23' title='Defined at 23 in src/lib/stdint.h.'>uint16_t</a> limit, <b>void</b> *base);
<a name='L58'>  58 
<a name='L59'>  59 <i><font color='green'>/* Interrupt handlers. */</font></i>
<a name='L60'>  60 <b>void</b> <a href='../S/168.html#L345' title='Defined at 345 in src/threads/interrupt.c.'>intr_handler</a> (<b>struct</b> intr_frame *args);
<a name='L61'>  61 <b>static</b> <b>void</b> <a href='../S/168.html#L394' title='Defined at 394 in src/threads/interrupt.c.'>unexpected_interrupt</a> (<b>const</b> <b>struct</b> intr_frame *);
<a name='L62'>  62 
<a name='L63'>  63 <i><font color='green'>/* Returns the current interrupt status. */</font></i>
<a name='L64'>  64 <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a>
<a name='L65'>  65 <a href='../R/549.html' title='Multiple refered from 26 places.'>intr_get_level</a> (<b>void</b>) 
<a name='L66'>  66 <font color='red'>{</font>
<a name='L67'>  67   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> flags;
<a name='L68'>  68 
<a name='L69'>  69   <i><font color='green'>/* Push the flags register on the processor stack, then pop the</font></i>
<a name='L70'>  70 <i><font color='green'>     value off the stack into `flags'.  See [IA32-v2b] "PUSHF"</font></i>
<a name='L71'>  71 <i><font color='green'>     and "POP" and [IA32-v3a] 5.8.1 "Masking Maskable Hardware</font></i>
<a name='L72'>  72 <i><font color='green'>     Interrupts". */</font></i>
<a name='L73'>  73   <b>asm</b> <b>volatile</b> ("pushfl; popl %0" : "=g" (flags));
<a name='L74'>  74 
<a name='L75'>  75   <b>return</b> flags &amp; <a href='../S/145.html#L6' title='Defined at 6 in src/threads/flags.h.'>FLAG_IF</a> ? INTR_ON : INTR_OFF;
<a name='L76'>  76 <font color='red'>}</font>
<a name='L77'>  77 
<a name='L78'>  78 <i><font color='green'>/* Enables or disables interrupts as specified by LEVEL and</font></i>
<a name='L79'>  79 <i><font color='green'>   returns the previous interrupt status. */</font></i>
<a name='L80'>  80 <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a>
<a name='L81'>  81 <a href='../R/557.html' title='Multiple refered from 18 places.'>intr_set_level</a> (<b>enum</b> intr_level level) 
<a name='L82'>  82 <font color='red'>{</font>
<a name='L83'>  83   <b>return</b> level == INTR_ON ? <a href='../S/168.html#L88' title='Defined at 88 in src/threads/interrupt.c.'>intr_enable</a> () : <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L84'>  84 <font color='red'>}</font>
<a name='L85'>  85 
<a name='L86'>  86 <i><font color='green'>/* Enables interrupts and returns the previous interrupt status. */</font></i>
<a name='L87'>  87 <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a>
<a name='L88'>  88 <a href='../R/547.html' title='Multiple refered from 5 places.'>intr_enable</a> (<b>void</b>) 
<a name='L89'>  89 <font color='red'>{</font>
<a name='L90'>  90   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level = <a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> ();
<a name='L91'>  91   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (!<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L92'>  92 
<a name='L93'>  93   <i><font color='green'>/* Enable interrupts by setting the interrupt flag.</font></i>
<a name='L94'>  94 <i><font color='green'></font></i>
<a name='L95'>  95 <i><font color='green'>     See [IA32-v2b] "STI" and [IA32-v3a] 5.8.1 "Masking Maskable</font></i>
<a name='L96'>  96 <i><font color='green'>     Hardware Interrupts". */</font></i>
<a name='L97'>  97   <b>asm</b> <b>volatile</b> ("sti");
<a name='L98'>  98 
<a name='L99'>  99   <b>return</b> old_level;
<a name='L100'> 100 <font color='red'>}</font>
<a name='L101'> 101 
<a name='L102'> 102 <i><font color='green'>/* Disables interrupts and returns the previous interrupt status. */</font></i>
<a name='L103'> 103 <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a>
<a name='L104'> 104 <a href='../R/545.html' title='Multiple refered from 22 places.'>intr_disable</a> (<b>void</b>) 
<a name='L105'> 105 <font color='red'>{</font>
<a name='L106'> 106   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level = <a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> ();
<a name='L107'> 107 
<a name='L108'> 108   <i><font color='green'>/* Disable interrupts by clearing the interrupt flag.</font></i>
<a name='L109'> 109 <i><font color='green'>     See [IA32-v2b] "CLI" and [IA32-v3a] 5.8.1 "Masking Maskable</font></i>
<a name='L110'> 110 <i><font color='green'>     Hardware Interrupts". */</font></i>
<a name='L111'> 111   <b>asm</b> <b>volatile</b> ("cli" : : : "memory");
<a name='L112'> 112 
<a name='L113'> 113   <b>return</b> old_level;
<a name='L114'> 114 <font color='red'>}</font>
<a name='L115'> 115 
<a name='L116'> 116 <i><font color='green'>/* Initializes the interrupt system. */</font></i>
<a name='L117'> 117 <b>void</b>
<a name='L118'> 118 <a href='../R/552.html' title='Multiple refered from 2 places.'>intr_init</a> (<b>void</b>)
<a name='L119'> 119 <font color='red'>{</font>
<a name='L120'> 120   <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a> idtr_operand;
<a name='L121'> 121   <b>int</b> i;
<a name='L122'> 122 
<a name='L123'> 123   <i><font color='green'>/* Initialize interrupt controller. */</font></i>
<a name='L124'> 124   <a href='../S/168.html#L238' title='Defined at 238 in src/threads/interrupt.c.'>pic_init</a> ();
<a name='L125'> 125 
<a name='L126'> 126   <i><font color='green'>/* Initialize IDT. */</font></i>
<a name='L127'> 127   <b>for</b> (i = 0; i &lt; <a href='../S/168.html#L22' title='Defined at 22 in src/threads/interrupt.c.'>INTR_CNT</a>; i++)
<a name='L128'> 128     idt[i] = <a href='../S/168.html#L317' title='Defined at 317 in src/threads/interrupt.c.'>make_intr_gate</a> (intr_stubs[i], 0);
<a name='L129'> 129 
<a name='L130'> 130   <i><font color='green'>/* Load IDT register.</font></i>
<a name='L131'> 131 <i><font color='green'>     See [IA32-v2a] "LIDT" and [IA32-v3a] 5.10 "Interrupt</font></i>
<a name='L132'> 132 <i><font color='green'>     Descriptor Table (IDT)". */</font></i>
<a name='L133'> 133   idtr_operand = <a href='../S/168.html#L333' title='Defined at 333 in src/threads/interrupt.c.'>make_idtr_operand</a> (<b>sizeof</b> idt - 1, idt);
<a name='L134'> 134   <b>asm</b> <b>volatile</b> ("lidt %0" : : "m" (idtr_operand));
<a name='L135'> 135 
<a name='L136'> 136   <i><font color='green'>/* Initialize intr_names. */</font></i>
<a name='L137'> 137   <b>for</b> (i = 0; i &lt; <a href='../S/168.html#L22' title='Defined at 22 in src/threads/interrupt.c.'>INTR_CNT</a>; i++)
<a name='L138'> 138     intr_names[i] = "unknown";
<a name='L139'> 139   intr_names[0] = "#DE Divide Error";
<a name='L140'> 140   intr_names[1] = "#DB Debug Exception";
<a name='L141'> 141   intr_names[2] = "NMI Interrupt";
<a name='L142'> 142   intr_names[3] = "#BP Breakpoint Exception";
<a name='L143'> 143   intr_names[4] = "#OF Overflow Exception";
<a name='L144'> 144   intr_names[5] = "#BR BOUND Range Exceeded Exception";
<a name='L145'> 145   intr_names[6] = "#UD Invalid Opcode Exception";
<a name='L146'> 146   intr_names[7] = "#NM Device Not Available Exception";
<a name='L147'> 147   intr_names[8] = "#DF Double Fault Exception";
<a name='L148'> 148   intr_names[9] = "Coprocessor Segment Overrun";
<a name='L149'> 149   intr_names[10] = "#TS Invalid TSS Exception";
<a name='L150'> 150   intr_names[11] = "#NP Segment Not Present";
<a name='L151'> 151   intr_names[12] = "#SS Stack Fault Exception";
<a name='L152'> 152   intr_names[13] = "#GP General Protection Exception";
<a name='L153'> 153   intr_names[14] = "#PF Page-Fault Exception";
<a name='L154'> 154   intr_names[16] = "#MF x87 FPU Floating-Point Error";
<a name='L155'> 155   intr_names[17] = "#AC Alignment Check Exception";
<a name='L156'> 156   intr_names[18] = "#MC Machine-Check Exception";
<a name='L157'> 157   intr_names[19] = "#XF SIMD Floating-Point Exception";
<a name='L158'> 158 <font color='red'>}</font>
<a name='L159'> 159 
<a name='L160'> 160 <i><font color='green'>/* Registers interrupt VEC_NO to invoke HANDLER with descriptor</font></i>
<a name='L161'> 161 <i><font color='green'>   privilege level DPL.  Names the interrupt NAME for debugging</font></i>
<a name='L162'> 162 <i><font color='green'>   purposes.  The interrupt handler will be invoked with</font></i>
<a name='L163'> 163 <i><font color='green'>   interrupt status set to LEVEL. */</font></i>
<a name='L164'> 164 <b>static</b> <b>void</b>
<a name='L165'> 165 <a href='../R/769.html' title='Multiple refered from 2 places.'>register_handler</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> vec_no, <b>int</b> dpl, <b>enum</b> intr_level level,
<a name='L166'> 166                   intr_handler_func *handler, <b>const</b> <b>char</b> *name)
<a name='L167'> 167 <font color='red'>{</font>
<a name='L168'> 168   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (intr_handlers[vec_no] == <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L169'> 169   <b>if</b> (level == INTR_ON)
<a name='L170'> 170     idt[vec_no] = <a href='../S/168.html#L325' title='Defined at 325 in src/threads/interrupt.c.'>make_trap_gate</a> (intr_stubs[vec_no], dpl);
<a name='L171'> 171   <b>else</b>
<a name='L172'> 172     idt[vec_no] = <a href='../S/168.html#L317' title='Defined at 317 in src/threads/interrupt.c.'>make_intr_gate</a> (intr_stubs[vec_no], dpl);
<a name='L173'> 173   intr_handlers[vec_no] = handler;
<a name='L174'> 174   intr_names[vec_no] = name;
<a name='L175'> 175 <font color='red'>}</font>
<a name='L176'> 176 
<a name='L177'> 177 <i><font color='green'>/* Registers external interrupt VEC_NO to invoke HANDLER, which</font></i>
<a name='L178'> 178 <i><font color='green'>   is named NAME for debugging purposes.  The handler will</font></i>
<a name='L179'> 179 <i><font color='green'>   execute with interrupts disabled. */</font></i>
<a name='L180'> 180 <b>void</b>
<a name='L181'> 181 <a href='../R/555.html' title='Multiple refered from 5 places.'>intr_register_ext</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> vec_no, intr_handler_func *handler,
<a name='L182'> 182                    <b>const</b> <b>char</b> *name) 
<a name='L183'> 183 <font color='red'>{</font>
<a name='L184'> 184   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (vec_no &gt;= 0x20 &amp;&amp; vec_no &lt;= 0x2f);
<a name='L185'> 185   <a href='../S/168.html#L165' title='Defined at 165 in src/threads/interrupt.c.'>register_handler</a> (vec_no, 0, INTR_OFF, handler, name);
<a name='L186'> 186 <font color='red'>}</font>
<a name='L187'> 187 
<a name='L188'> 188 <i><font color='green'>/* Registers internal interrupt VEC_NO to invoke HANDLER, which</font></i>
<a name='L189'> 189 <i><font color='green'>   is named NAME for debugging purposes.  The interrupt handler</font></i>
<a name='L190'> 190 <i><font color='green'>   will be invoked with interrupt status LEVEL.</font></i>
<a name='L191'> 191 <i><font color='green'></font></i>
<a name='L192'> 192 <i><font color='green'>   The handler will have descriptor privilege level DPL, meaning</font></i>
<a name='L193'> 193 <i><font color='green'>   that it can be invoked intentionally when the processor is in</font></i>
<a name='L194'> 194 <i><font color='green'>   the DPL or lower-numbered ring.  In practice, DPL==3 allows</font></i>
<a name='L195'> 195 <i><font color='green'>   user mode to invoke the interrupts and DPL==0 prevents such</font></i>
<a name='L196'> 196 <i><font color='green'>   invocation.  Faults and exceptions that occur in user mode</font></i>
<a name='L197'> 197 <i><font color='green'>   still cause interrupts with DPL==0 to be invoked.  See</font></i>
<a name='L198'> 198 <i><font color='green'>   [IA32-v3a] sections 4.5 "Privilege Levels" and 4.8.1.1</font></i>
<a name='L199'> 199 <i><font color='green'>   "Accessing Nonconforming Code Segments" for further</font></i>
<a name='L200'> 200 <i><font color='green'>   discussion. */</font></i>
<a name='L201'> 201 <b>void</b>
<a name='L202'> 202 <a href='../R/556.html' title='Multiple refered from 15 places.'>intr_register_int</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> vec_no, <b>int</b> dpl, <b>enum</b> intr_level level,
<a name='L203'> 203                    intr_handler_func *handler, <b>const</b> <b>char</b> *name)
<a name='L204'> 204 <font color='red'>{</font>
<a name='L205'> 205   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (vec_no &lt; 0x20 || vec_no &gt; 0x2f);
<a name='L206'> 206   <a href='../S/168.html#L165' title='Defined at 165 in src/threads/interrupt.c.'>register_handler</a> (vec_no, dpl, level, handler, name);
<a name='L207'> 207 <font color='red'>}</font>
<a name='L208'> 208 
<a name='L209'> 209 <i><font color='green'>/* Returns true during processing of an external interrupt</font></i>
<a name='L210'> 210 <i><font color='green'>   and false at all other times. */</font></i>
<a name='L211'> 211 <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a>
<a name='L212'> 212 <a href='../R/544.html' title='Multiple refered from 18 places.'>intr_context</a> (<b>void</b>) 
<a name='L213'> 213 <font color='red'>{</font>
<a name='L214'> 214   <b>return</b> in_external_intr;
<a name='L215'> 215 <font color='red'>}</font>
<a name='L216'> 216 
<a name='L217'> 217 <i><font color='green'>/* During processing of an external interrupt, directs the</font></i>
<a name='L218'> 218 <i><font color='green'>   interrupt handler to yield to a new process just before</font></i>
<a name='L219'> 219 <i><font color='green'>   returning from the interrupt.  May not be called at any other</font></i>
<a name='L220'> 220 <i><font color='green'>   time. */</font></i>
<a name='L221'> 221 <b>void</b>
<a name='L222'> 222 <a href='../R/559.html' title='Multiple refered from 2 places.'>intr_yield_on_return</a> (<b>void</b>) 
<a name='L223'> 223 <font color='red'>{</font>
<a name='L224'> 224   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L225'> 225   yield_on_return = <a href='../S/78.html#L5' title='Defined at 5 in src/lib/stdbool.h.'>true</a>;
<a name='L226'> 226 <font color='red'>}</font>
<a name='L227'> 227 
<a name='L228'> 228 <i><font color='green'>/* 8259A Programmable Interrupt Controller. */</font></i>
<a name='L229'> 229 
<a name='L230'> 230 <i><font color='green'>/* Initializes the PICs.  Refer to [8259A] for details.</font></i>
<a name='L231'> 231 <i><font color='green'></font></i>
<a name='L232'> 232 <i><font color='green'>   By default, interrupts 0...15 delivered by the PICs will go to</font></i>
<a name='L233'> 233 <i><font color='green'>   interrupt vectors 0...15.  Those vectors are also used for CPU</font></i>
<a name='L234'> 234 <i><font color='green'>   traps and exceptions, so we reprogram the PICs so that</font></i>
<a name='L235'> 235 <i><font color='green'>   interrupts 0...15 are delivered to interrupt vectors 32...47</font></i>
<a name='L236'> 236 <i><font color='green'>   (0x20...0x2f) instead. */</font></i>
<a name='L237'> 237 <b>static</b> <b>void</b>
<a name='L238'> 238 <a href='../R/717.html' title='Multiple refered from 2 places.'>pic_init</a> (<b>void</b>)
<a name='L239'> 239 <font color='red'>{</font>
<a name='L240'> 240   <i><font color='green'>/* Mask all interrupts on both PICs. */</font></i>
<a name='L241'> 241   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L17' title='Defined at 17 in src/threads/interrupt.c.'>PIC0_DATA</a>, 0xff);
<a name='L242'> 242   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L19' title='Defined at 19 in src/threads/interrupt.c.'>PIC1_DATA</a>, 0xff);
<a name='L243'> 243 
<a name='L244'> 244   <i><font color='green'>/* Initialize master. */</font></i>
<a name='L245'> 245   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L16' title='Defined at 16 in src/threads/interrupt.c.'>PIC0_CTRL</a>, 0x11); <i><font color='green'>/* ICW1: single mode, edge triggered, expect ICW4. */</font></i>
<a name='L246'> 246   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L17' title='Defined at 17 in src/threads/interrupt.c.'>PIC0_DATA</a>, 0x20); <i><font color='green'>/* ICW2: line IR0...7 -&gt; irq 0x20...0x27. */</font></i>
<a name='L247'> 247   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L17' title='Defined at 17 in src/threads/interrupt.c.'>PIC0_DATA</a>, 0x04); <i><font color='green'>/* ICW3: slave PIC on line IR2. */</font></i>
<a name='L248'> 248   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L17' title='Defined at 17 in src/threads/interrupt.c.'>PIC0_DATA</a>, 0x01); <i><font color='green'>/* ICW4: 8086 mode, normal EOI, non-buffered. */</font></i>
<a name='L249'> 249 
<a name='L250'> 250   <i><font color='green'>/* Initialize slave. */</font></i>
<a name='L251'> 251   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L18' title='Defined at 18 in src/threads/interrupt.c.'>PIC1_CTRL</a>, 0x11); <i><font color='green'>/* ICW1: single mode, edge triggered, expect ICW4. */</font></i>
<a name='L252'> 252   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L19' title='Defined at 19 in src/threads/interrupt.c.'>PIC1_DATA</a>, 0x28); <i><font color='green'>/* ICW2: line IR0...7 -&gt; irq 0x28...0x2f. */</font></i>
<a name='L253'> 253   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L19' title='Defined at 19 in src/threads/interrupt.c.'>PIC1_DATA</a>, 0x02); <i><font color='green'>/* ICW3: slave ID is 2. */</font></i>
<a name='L254'> 254   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L19' title='Defined at 19 in src/threads/interrupt.c.'>PIC1_DATA</a>, 0x01); <i><font color='green'>/* ICW4: 8086 mode, normal EOI, non-buffered. */</font></i>
<a name='L255'> 255 
<a name='L256'> 256   <i><font color='green'>/* Unmask all interrupts. */</font></i>
<a name='L257'> 257   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L17' title='Defined at 17 in src/threads/interrupt.c.'>PIC0_DATA</a>, 0x00);
<a name='L258'> 258   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/168.html#L19' title='Defined at 19 in src/threads/interrupt.c.'>PIC1_DATA</a>, 0x00);
<a name='L259'> 259 <font color='red'>}</font>
<a name='L260'> 260 
<a name='L261'> 261 <i><font color='green'>/* Sends an end-of-interrupt signal to the PIC for the given IRQ.</font></i>
<a name='L262'> 262 <i><font color='green'>   If we don't acknowledge the IRQ, it will never be delivered to</font></i>
<a name='L263'> 263 <i><font color='green'>   us again, so this is important.  */</font></i>
<a name='L264'> 264 <b>static</b> <b>void</b>
<a name='L265'> 265 <a href='../R/716.html' title='Multiple refered from 2 places.'>pic_end_of_interrupt</a> (<b>int</b> irq) 
<a name='L266'> 266 <font color='red'>{</font>
<a name='L267'> 267   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (irq &gt;= 0x20 &amp;&amp; irq &lt; 0x30);
<a name='L268'> 268 
<a name='L269'> 269   <i><font color='green'>/* Acknowledge master PIC. */</font></i>
<a name='L270'> 270   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (0x20, 0x20);
<a name='L271'> 271 
<a name='L272'> 272   <i><font color='green'>/* Acknowledge slave PIC if this is a slave interrupt. */</font></i>
<a name='L273'> 273   <b>if</b> (irq &gt;= 0x28)
<a name='L274'> 274     <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (0xa0, 0x20);
<a name='L275'> 275 <font color='red'>}</font>
<a name='L276'> 276 
<a name='L277'> 277 <i><font color='green'>/* Creates an gate that invokes FUNCTION.</font></i>
<a name='L278'> 278 <i><font color='green'></font></i>
<a name='L279'> 279 <i><font color='green'>   The gate has descriptor privilege level DPL, meaning that it</font></i>
<a name='L280'> 280 <i><font color='green'>   can be invoked intentionally when the processor is in the DPL</font></i>
<a name='L281'> 281 <i><font color='green'>   or lower-numbered ring.  In practice, DPL==3 allows user mode</font></i>
<a name='L282'> 282 <i><font color='green'>   to call into the gate and DPL==0 prevents such calls.  Faults</font></i>
<a name='L283'> 283 <i><font color='green'>   and exceptions that occur in user mode still cause gates with</font></i>
<a name='L284'> 284 <i><font color='green'>   DPL==0 to be invoked.  See [IA32-v3a] sections 4.5 "Privilege</font></i>
<a name='L285'> 285 <i><font color='green'>   Levels" and 4.8.1.1 "Accessing Nonconforming Code Segments"</font></i>
<a name='L286'> 286 <i><font color='green'>   for further discussion.</font></i>
<a name='L287'> 287 <i><font color='green'></font></i>
<a name='L288'> 288 <i><font color='green'>   TYPE must be either 14 (for an interrupt gate) or 15 (for a</font></i>
<a name='L289'> 289 <i><font color='green'>   trap gate).  The difference is that entering an interrupt gate</font></i>
<a name='L290'> 290 <i><font color='green'>   disables interrupts, but entering a trap gate does not.  See</font></i>
<a name='L291'> 291 <i><font color='green'>   [IA32-v3a] section 5.12.1.2 "Flag Usage By Exception- or</font></i>
<a name='L292'> 292 <i><font color='green'>   Interrupt-Handler Procedure" for discussion. */</font></i>
<a name='L293'> 293 <b>static</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a>
<a name='L294'> 294 <a href='../R/642.html' title='Multiple refered from 2 places.'>make_gate</a> (<b>void</b> (*function) (<b>void</b>), <b>int</b> dpl, <b>int</b> type)
<a name='L295'> 295 <font color='red'>{</font>
<a name='L296'> 296   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> e0, e1;
<a name='L297'> 297 
<a name='L298'> 298   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (function != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L299'> 299   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (dpl &gt;= 0 &amp;&amp; dpl &lt;= 3);
<a name='L300'> 300   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (type &gt;= 0 &amp;&amp; type &lt;= 15);
<a name='L301'> 301 
<a name='L302'> 302   e0 = (((<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) function &amp; 0xffff)     <i><font color='green'>/* Offset 15:0. */</font></i>
<a name='L303'> 303         | (<a href='../S/152.html#L30' title='Defined at 30 in src/threads/loader.h.'>SEL_KCSEG</a> &lt;&lt; 16));              <i><font color='green'>/* Target code segment. */</font></i>
<a name='L304'> 304 
<a name='L305'> 305   e1 = (((<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) function &amp; 0xffff0000) <i><font color='green'>/* Offset 31:16. */</font></i>
<a name='L306'> 306         | (1 &lt;&lt; 15)                        <i><font color='green'>/* Present. */</font></i>
<a name='L307'> 307         | ((<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) dpl &lt;&lt; 13)           <i><font color='green'>/* Descriptor privilege level. */</font></i>
<a name='L308'> 308         | (0 &lt;&lt; 12)                        <i><font color='green'>/* System. */</font></i>
<a name='L309'> 309         | ((<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) type &lt;&lt; 8));         <i><font color='green'>/* Gate type. */</font></i>
<a name='L310'> 310 
<a name='L311'> 311   <b>return</b> e0 | ((<a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a>) e1 &lt;&lt; 32);
<a name='L312'> 312 <font color='red'>}</font>
<a name='L313'> 313 
<a name='L314'> 314 <i><font color='green'>/* Creates an interrupt gate that invokes FUNCTION with the given</font></i>
<a name='L315'> 315 <i><font color='green'>   DPL. */</font></i>
<a name='L316'> 316 <b>static</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a>
<a name='L317'> 317 <a href='../R/645.html' title='Multiple refered from 3 places.'>make_intr_gate</a> (<b>void</b> (*function) (<b>void</b>), <b>int</b> dpl)
<a name='L318'> 318 <font color='red'>{</font>
<a name='L319'> 319   <b>return</b> <a href='../S/168.html#L294' title='Defined at 294 in src/threads/interrupt.c.'>make_gate</a> (function, dpl, 14);
<a name='L320'> 320 <font color='red'>}</font>
<a name='L321'> 321 
<a name='L322'> 322 <i><font color='green'>/* Creates a trap gate that invokes FUNCTION with the given</font></i>
<a name='L323'> 323 <i><font color='green'>   DPL. */</font></i>
<a name='L324'> 324 <b>static</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a>
<a name='L325'> 325 <a href='../R/650.html' title='Multiple refered from 2 places.'>make_trap_gate</a> (<b>void</b> (*function) (<b>void</b>), <b>int</b> dpl)
<a name='L326'> 326 <font color='red'>{</font>
<a name='L327'> 327   <b>return</b> <a href='../S/168.html#L294' title='Defined at 294 in src/threads/interrupt.c.'>make_gate</a> (function, dpl, 15);
<a name='L328'> 328 <font color='red'>}</font>
<a name='L329'> 329 
<a name='L330'> 330 <i><font color='green'>/* Returns a descriptor that yields the given LIMIT and BASE when</font></i>
<a name='L331'> 331 <i><font color='green'>   used as an operand for the LIDT instruction. */</font></i>
<a name='L332'> 332 <b>static</b> <b>inline</b> <a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a>
<a name='L333'> 333 <a href='../R/644.html' title='Multiple refered from 2 places.'>make_idtr_operand</a> (<a href='../S/87.html#L23' title='Defined at 23 in src/lib/stdint.h.'>uint16_t</a> limit, <b>void</b> *base)
<a name='L334'> 334 <font color='red'>{</font>
<a name='L335'> 335   <b>return</b> limit | ((<a href='../S/87.html#L29' title='Defined at 29 in src/lib/stdint.h.'>uint64_t</a>) (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) base &lt;&lt; 16);
<a name='L336'> 336 <font color='red'>}</font>
<a name='L337'> 337 
<a name='L338'> 338 <i><font color='green'>/* Interrupt handlers. */</font></i>
<a name='L339'> 339 
<a name='L340'> 340 <i><font color='green'>/* Handler for all interrupts, faults, and exceptions.  This</font></i>
<a name='L341'> 341 <i><font color='green'>   function is called by the assembly language interrupt stubs in</font></i>
<a name='L342'> 342 <i><font color='green'>   intr-stubs.S.  FRAME describes the interrupt and the</font></i>
<a name='L343'> 343 <i><font color='green'>   interrupted thread's registers. */</font></i>
<a name='L344'> 344 <b>void</b>
<a name='L345'> 345 <a href='../S/168.html#L60' title='Refered from 60 in src/threads/interrupt.c.'>intr_handler</a> (<b>struct</b> intr_frame *frame) 
<a name='L346'> 346 <font color='red'>{</font>
<a name='L347'> 347   <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a> external;
<a name='L348'> 348   <a href='../S/150.html#L58' title='Defined at 58 in src/threads/interrupt.h.'>intr_handler_func</a> *handler;
<a name='L349'> 349 
<a name='L350'> 350   <i><font color='green'>/* External interrupts are special.</font></i>
<a name='L351'> 351 <i><font color='green'>     We only handle one at a time (so interrupts must be off)</font></i>
<a name='L352'> 352 <i><font color='green'>     and they need to be acknowledged on the PIC (see below).</font></i>
<a name='L353'> 353 <i><font color='green'>     An external interrupt handler cannot sleep. */</font></i>
<a name='L354'> 354   external = frame-&gt;vec_no &gt;= 0x20 &amp;&amp; frame-&gt;vec_no &lt; 0x30;
<a name='L355'> 355   <b>if</b> (external) 
<a name='L356'> 356     <font color='red'>{</font>
<a name='L357'> 357       <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L358'> 358       <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (!<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L359'> 359 
<a name='L360'> 360       in_external_intr = <a href='../S/78.html#L5' title='Defined at 5 in src/lib/stdbool.h.'>true</a>;
<a name='L361'> 361       yield_on_return = <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>;
<a name='L362'> 362     <font color='red'>}</font>
<a name='L363'> 363 
<a name='L364'> 364   <i><font color='green'>/* Invoke the interrupt's handler. */</font></i>
<a name='L365'> 365   handler = intr_handlers[frame-&gt;vec_no];
<a name='L366'> 366   <b>if</b> (handler != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>)
<a name='L367'> 367     handler (frame);
<a name='L368'> 368   <b>else</b> <b>if</b> (frame-&gt;vec_no == 0x27 || frame-&gt;vec_no == 0x2f)
<a name='L369'> 369     <font color='red'>{</font>
<a name='L370'> 370       <i><font color='green'>/* There is no handler, but this interrupt can trigger</font></i>
<a name='L371'> 371 <i><font color='green'>         spuriously due to a hardware fault or hardware race</font></i>
<a name='L372'> 372 <i><font color='green'>         condition.  Ignore it. */</font></i>
<a name='L373'> 373     <font color='red'>}</font>
<a name='L374'> 374   <b>else</b>
<a name='L375'> 375     <a href='../S/168.html#L394' title='Defined at 394 in src/threads/interrupt.c.'>unexpected_interrupt</a> (frame);
<a name='L376'> 376 
<a name='L377'> 377   <i><font color='green'>/* Complete the processing of an external interrupt. */</font></i>
<a name='L378'> 378   <b>if</b> (external) 
<a name='L379'> 379     <font color='red'>{</font>
<a name='L380'> 380       <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L381'> 381       <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L382'> 382 
<a name='L383'> 383       in_external_intr = <a href='../S/78.html#L6' title='Defined at 6 in src/lib/stdbool.h.'>false</a>;
<a name='L384'> 384       <a href='../S/168.html#L265' title='Defined at 265 in src/threads/interrupt.c.'>pic_end_of_interrupt</a> (frame-&gt;vec_no); 
<a name='L385'> 385 
<a name='L386'> 386       <b>if</b> (yield_on_return) 
<a name='L387'> 387         <a href='../S/163.html#L310' title='Defined at 310 in src/threads/thread.c.'>thread_yield</a> (); 
<a name='L388'> 388     <font color='red'>}</font>
<a name='L389'> 389 <font color='red'>}</font>
<a name='L390'> 390 
<a name='L391'> 391 <i><font color='green'>/* Handles an unexpected interrupt with interrupt frame F.  An</font></i>
<a name='L392'> 392 <i><font color='green'>   unexpected interrupt is one that has no registered handler. */</font></i>
<a name='L393'> 393 <b>static</b> <b>void</b>
<a name='L394'> 394 <a href='../R/942.html' title='Multiple refered from 2 places.'>unexpected_interrupt</a> (<b>const</b> <b>struct</b> intr_frame *f)
<a name='L395'> 395 <font color='red'>{</font>
<a name='L396'> 396   <i><font color='green'>/* Count the number so far. */</font></i>
<a name='L397'> 397   <b>unsigned</b> <b>int</b> n = ++unexpected_cnt[f-&gt;vec_no];
<a name='L398'> 398 
<a name='L399'> 399   <i><font color='green'>/* If the number is a power of 2, print a message.  This rate</font></i>
<a name='L400'> 400 <i><font color='green'>     limiting means that we get information about an uncommon</font></i>
<a name='L401'> 401 <i><font color='green'>     unexpected interrupt the first time and fairly often after</font></i>
<a name='L402'> 402 <i><font color='green'>     that, but one that occurs many times will not overwhelm the</font></i>
<a name='L403'> 403 <i><font color='green'>     console. */</font></i>
<a name='L404'> 404   <b>if</b> ((n &amp; (n - 1)) == 0)
<a name='L405'> 405     <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> ("Unexpected interrupt %#04x (%s)\n",
<a name='L406'> 406     f-&gt;vec_no, intr_names[f-&gt;vec_no]);
<a name='L407'> 407 <font color='red'>}</font>
<a name='L408'> 408 
<a name='L409'> 409 <i><font color='green'>/* Dumps interrupt frame F to the console, for debugging. */</font></i>
<a name='L410'> 410 <b>void</b>
<a name='L411'> 411 <a href='../R/546.html' title='Multiple refered from 3 places.'>intr_dump_frame</a> (<b>const</b> <b>struct</b> intr_frame *f) 
<a name='L412'> 412 <font color='red'>{</font>
<a name='L413'> 413   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> cr2;
<a name='L414'> 414 
<a name='L415'> 415   <i><font color='green'>/* Store current value of CR2 into `cr2'.</font></i>
<a name='L416'> 416 <i><font color='green'>     CR2 is the linear address of the last page fault.</font></i>
<a name='L417'> 417 <i><font color='green'>     See [IA32-v2a] "MOV--Move to/from Control Registers" and</font></i>
<a name='L418'> 418 <i><font color='green'>     [IA32-v3a] 5.14 "Interrupt 14--Page Fault Exception</font></i>
<a name='L419'> 419 <i><font color='green'>     (#PF)". */</font></i>
<a name='L420'> 420   <b>asm</b> ("movl %%cr2, %0" : "=r" (cr2));
<a name='L421'> 421 
<a name='L422'> 422   <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> ("Interrupt %#04x (%s) at eip=%p\n",
<a name='L423'> 423           f-&gt;vec_no, intr_names[f-&gt;vec_no], f-&gt;eip);
<a name='L424'> 424   <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> (" cr2=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" error=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>"\n", cr2, f-&gt;error_code);
<a name='L425'> 425   <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> (" eax=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" ebx=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" ecx=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" edx=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>"\n",
<a name='L426'> 426           f-&gt;eax, f-&gt;ebx, f-&gt;ecx, f-&gt;edx);
<a name='L427'> 427   <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> (" esi=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" edi=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" esp=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>" ebp=%08"<a href='../S/81.html#L24' title='Defined at 24 in src/lib/inttypes.h.'>PRIx32</a>"\n",
<a name='L428'> 428           f-&gt;esi, f-&gt;edi, (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) f-&gt;esp, f-&gt;ebp);
<a name='L429'> 429   <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> (" cs=%04"<a href='../S/81.html#L17' title='Defined at 17 in src/lib/inttypes.h.'>PRIx16</a>" ds=%04"<a href='../S/81.html#L17' title='Defined at 17 in src/lib/inttypes.h.'>PRIx16</a>" es=%04"<a href='../S/81.html#L17' title='Defined at 17 in src/lib/inttypes.h.'>PRIx16</a>" ss=%04"<a href='../S/81.html#L17' title='Defined at 17 in src/lib/inttypes.h.'>PRIx16</a>"\n",
<a name='L430'> 430           f-&gt;cs, f-&gt;ds, f-&gt;es, f-&gt;ss);
<a name='L431'> 431 <font color='red'>}</font>
<a name='L432'> 432 
<a name='L433'> 433 <i><font color='green'>/* Returns the name of interrupt VEC. */</font></i>
<a name='L434'> 434 <b>const</b> <b>char</b> *
<a name='L435'> 435 <a href='../R/554.html' title='Multiple refered from 3 places.'>intr_name</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> vec) 
<a name='L436'> 436 <font color='red'>{</font>
<a name='L437'> 437   <b>return</b> intr_names[vec];
<a name='L438'> 438 <font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L65'>[^]</a><a href='#L435'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
