<html>
<head>
<title>src/devices/serial.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/595.html'>src</a>/<a href='../files/596.html'>devices</a>/serial.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L67'>[^]</a><a href='#L210'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L67' title='Defined at 67.'>init_poll</a>
<li><a href='#L82' title='Defined at 82.'>serial_init_queue</a>
<li><a href='#L99' title='Defined at 99.'>serial_putc</a>
<li><a href='#L135' title='Defined at 135.'>serial_flush</a>
<li><a href='#L148' title='Defined at 148.'>serial_notify</a>
<li><a href='#L157' title='Defined at 157.'>set_serial</a>
<li><a href='#L177' title='Defined at 177.'>write_ier</a>
<li><a href='#L199' title='Defined at 199.'>putc_poll</a>
<li><a href='#L210' title='Defined at 210.'>serial_interrupt</a>
</ol>
<hr>
<pre>
<a name='L1'>   1 <font color='darkred'>#include</font> "<a href='137.html'>devices/serial.h</a>"
<a name='L2'>   2 <font color='darkred'>#include</font> &lt;<a href='104.html'>debug.h</a>&gt;
<a name='L3'>   3 <font color='darkred'>#include</font> "<a href='120.html'>devices/input.h</a>"
<a name='L4'>   4 <font color='darkred'>#include</font> "<a href='130.html'>devices/intq.h</a>"
<a name='L5'>   5 <font color='darkred'>#include</font> "<a href='124.html'>devices/timer.h</a>"
<a name='L6'>   6 <font color='darkred'>#include</font> "<a href='157.html'>threads/io.h</a>"
<a name='L7'>   7 <font color='darkred'>#include</font> "<a href='150.html'>threads/interrupt.h</a>"
<a name='L8'>   8 <font color='darkred'>#include</font> "<a href='155.html'>threads/synch.h</a>"
<a name='L9'>   9 <font color='darkred'>#include</font> "<a href='164.html'>threads/thread.h</a>"
<a name='L10'>  10 
<a name='L11'>  11 <i><font color='green'>/* Register definitions for the 16550A UART used in PCs.</font></i>
<a name='L12'>  12 <i><font color='green'>   The 16550A has a lot more going on than shown here, but this</font></i>
<a name='L13'>  13 <i><font color='green'>   is all we need.</font></i>
<a name='L14'>  14 <i><font color='green'></font></i>
<a name='L15'>  15 <i><font color='green'>   Refer to [PC16650D] for hardware information. */</font></i>
<a name='L16'>  16 
<a name='L17'>  17 <i><font color='green'>/* I/O port base address for the first serial port. */</font></i>
<a name='L18'>  18 <font color='darkred'>#define</font> <a href='../R/81.html' title='Multiple refered from 10 places.'>IO_BASE</a> 0x3f8
<a name='L19'>  19 
<a name='L20'>  20 <i><font color='green'>/* DLAB=0 registers. */</font></i>
<a name='L21'>  21 <font color='darkred'>#define</font> <a href='../S/142.html#L219' title='Refered from 219 in src/devices/serial.c.'>RBR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 0)   <i><font color='green'>/* Receiver Buffer Reg. (read-only). */</font></i>
<a name='L22'>  22 <font color='darkred'>#define</font> <a href='../R/232.html' title='Multiple refered from 2 places.'>THR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 0)   <i><font color='green'>/* Transmitter Holding Reg. (write-only). */</font></i>
<a name='L23'>  23 <font color='darkred'>#define</font> <a href='../R/67.html' title='Multiple refered from 2 places.'>IER_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 1)   <i><font color='green'>/* Interrupt Enable Reg.. */</font></i>
<a name='L24'>  24 
<a name='L25'>  25 <i><font color='green'>/* DLAB=1 registers. */</font></i>
<a name='L26'>  26 <font color='darkred'>#define</font> <a href='../S/142.html#L168' title='Refered from 168 in src/devices/serial.c.'>LS_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 0)    <i><font color='green'>/* Divisor Latch (LSB). */</font></i>
<a name='L27'>  27 <font color='darkred'>#define</font> <a href='../S/142.html#L169' title='Refered from 169 in src/devices/serial.c.'>MS_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 1)    <i><font color='green'>/* Divisor Latch (MSB). */</font></i>
<a name='L28'>  28 
<a name='L29'>  29 <i><font color='green'>/* DLAB-insensitive registers. */</font></i>
<a name='L30'>  30 <font color='darkred'>#define</font> <a href='../S/142.html#L214' title='Refered from 214 in src/devices/serial.c.'>IIR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 2)   <i><font color='green'>/* Interrupt Identification Reg. (read-only) */</font></i>
<a name='L31'>  31 <font color='darkred'>#define</font> <a href='../S/142.html#L71' title='Refered from 71 in src/devices/serial.c.'>FCR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 2)   <i><font color='green'>/* FIFO Control Reg. (write-only). */</font></i>
<a name='L32'>  32 <font color='darkred'>#define</font> <a href='../R/85.html' title='Multiple refered from 2 places.'>LCR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 3)   <i><font color='green'>/* Line Control Register. */</font></i>
<a name='L33'>  33 <font color='darkred'>#define</font> <a href='../S/142.html#L73' title='Refered from 73 in src/devices/serial.c.'>MCR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 4)   <i><font color='green'>/* MODEM Control Register. */</font></i>
<a name='L34'>  34 <font color='darkred'>#define</font> <a href='../R/100.html' title='Multiple refered from 3 places.'>LSR_REG</a> (<a href='../S/142.html#L18' title='Defined at 18 in src/devices/serial.c.'>IO_BASE</a> + 5)   <i><font color='green'>/* Line Status Register (read-only). */</font></i>
<a name='L35'>  35 
<a name='L36'>  36 <i><font color='green'>/* Interrupt Enable Register bits. */</font></i>
<a name='L37'>  37 <font color='darkred'>#define</font> <a href='../S/142.html#L191' title='Refered from 191 in src/devices/serial.c.'>IER_RECV</a> 0x01           <i><font color='green'>/* Interrupt when data received. */</font></i>
<a name='L38'>  38 <font color='darkred'>#define</font> <a href='../S/142.html#L186' title='Refered from 186 in src/devices/serial.c.'>IER_XMIT</a> 0x02           <i><font color='green'>/* Interrupt when transmit finishes. */</font></i>
<a name='L39'>  39 
<a name='L40'>  40 <i><font color='green'>/* Line Control Register bits. */</font></i>
<a name='L41'>  41 <font color='darkred'>#define</font> <a href='../R/84.html' title='Multiple refered from 2 places.'>LCR_N81</a> 0x03            <i><font color='green'>/* No parity, 8 data bits, 1 stop bit. */</font></i>
<a name='L42'>  42 <font color='darkred'>#define</font> <a href='../S/142.html#L165' title='Refered from 165 in src/devices/serial.c.'>LCR_DLAB</a> 0x80           <i><font color='green'>/* Divisor Latch Access Bit (DLAB). */</font></i>
<a name='L43'>  43 
<a name='L44'>  44 <i><font color='green'>/* MODEM Control Register. */</font></i>
<a name='L45'>  45 <font color='darkred'>#define</font> <a href='../S/142.html#L73' title='Refered from 73 in src/devices/serial.c.'>MCR_OUT2</a> 0x08           <i><font color='green'>/* Output line 2. */</font></i>
<a name='L46'>  46 
<a name='L47'>  47 <i><font color='green'>/* Line Status Register. */</font></i>
<a name='L48'>  48 <font color='darkred'>#define</font> <a href='../S/142.html#L218' title='Refered from 218 in src/devices/serial.c.'>LSR_DR</a> 0x01             <i><font color='green'>/* Data Ready: received data byte is in RBR. */</font></i>
<a name='L49'>  49 <font color='darkred'>#define</font> <a href='../R/101.html' title='Multiple refered from 2 places.'>LSR_THRE</a> 0x20           <i><font color='green'>/* THR Empty. */</font></i>
<a name='L50'>  50 
<a name='L51'>  51 <i><font color='green'>/* Transmission mode. */</font></i>
<a name='L52'>  52 <b>static</b> <b>enum</b> <font color='red'>{</font> <a href='../R/241.html' title='Multiple refered from 3 places.'>UNINIT</a>, <a href='../R/138.html' title='Multiple refered from 2 places.'>POLL</a>, <a href='../R/169.html' title='Multiple refered from 3 places.'>QUEUE</a> <font color='red'>}</font> mode;
<a name='L53'>  53 
<a name='L54'>  54 <i><font color='green'>/* Data to be transmitted. */</font></i>
<a name='L55'>  55 <b>static</b> <b>struct</b> <a href='../S/130.html#L24' title='Defined at 24 in src/devices/intq.h.'>intq</a> txq;
<a name='L56'>  56 
<a name='L57'>  57 <b>static</b> <b>void</b> <a href='../S/142.html#L157' title='Defined at 157 in src/devices/serial.c.'>set_serial</a> (<b>int</b> bps);
<a name='L58'>  58 <b>static</b> <b>void</b> <a href='../S/142.html#L199' title='Defined at 199 in src/devices/serial.c.'>putc_poll</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a>);
<a name='L59'>  59 <b>static</b> <b>void</b> <a href='../S/142.html#L177' title='Defined at 177 in src/devices/serial.c.'>write_ier</a> (<b>void</b>);
<a name='L60'>  60 <b>static</b> <a href='../S/150.html#L58' title='Defined at 58 in src/threads/interrupt.h.'>intr_handler_func</a> <a href='../S/142.html#L210' title='Defined at 210 in src/devices/serial.c.'>serial_interrupt</a>;
<a name='L61'>  61 
<a name='L62'>  62 <i><font color='green'>/* Initializes the serial port device for polling mode.</font></i>
<a name='L63'>  63 <i><font color='green'>   Polling mode busy-waits for the serial port to become free</font></i>
<a name='L64'>  64 <i><font color='green'>   before writing to it.  It's slow, but until interrupts have</font></i>
<a name='L65'>  65 <i><font color='green'>   been initialized it's all we can do. */</font></i>
<a name='L66'>  66 <b>static</b> <b>void</b>
<a name='L67'>  67 <a href='../R/506.html' title='Multiple refered from 2 places.'>init_poll</a> (<b>void</b>) 
<a name='L68'>  68 <font color='red'>{</font>
<a name='L69'>  69   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (mode == <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>UNINIT</a>);
<a name='L70'>  70   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L23' title='Defined at 23 in src/devices/serial.c.'>IER_REG</a>, 0);                    <i><font color='green'>/* Turn off all interrupts. */</font></i>
<a name='L71'>  71   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L31' title='Defined at 31 in src/devices/serial.c.'>FCR_REG</a>, 0);                    <i><font color='green'>/* Disable FIFO. */</font></i>
<a name='L72'>  72   <a href='../S/142.html#L157' title='Defined at 157 in src/devices/serial.c.'>set_serial</a> (9600);                    <i><font color='green'>/* 9.6 kbps, N-8-1. */</font></i>
<a name='L73'>  73   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L33' title='Defined at 33 in src/devices/serial.c.'>MCR_REG</a>, <a href='../S/142.html#L45' title='Defined at 45 in src/devices/serial.c.'>MCR_OUT2</a>);             <i><font color='green'>/* Required to enable interrupts. */</font></i>
<a name='L74'>  74   <a href='../S/135.html#L11' title='Defined at 11 in src/devices/intq.c.'>intq_init</a> (&amp;txq);
<a name='L75'>  75   mode = <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>POLL</a>;
<a name='L76'>  76 <font color='red'>}</font> 
<a name='L77'>  77 
<a name='L78'>  78 <i><font color='green'>/* Initializes the serial port device for queued interrupt-driven</font></i>
<a name='L79'>  79 <i><font color='green'>   I/O.  With interrupt-driven I/O we don't waste CPU time</font></i>
<a name='L80'>  80 <i><font color='green'>   waiting for the serial device to become ready. */</font></i>
<a name='L81'>  81 <b>void</b>
<a name='L82'>  82 <a href='../R/798.html' title='Multiple refered from 2 places.'>serial_init_queue</a> (<b>void</b>) 
<a name='L83'>  83 <font color='red'>{</font>
<a name='L84'>  84   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level;
<a name='L85'>  85 
<a name='L86'>  86   <b>if</b> (mode == <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>UNINIT</a>)
<a name='L87'>  87     <a href='../S/142.html#L67' title='Defined at 67 in src/devices/serial.c.'>init_poll</a> ();
<a name='L88'>  88   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (mode == <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>POLL</a>);
<a name='L89'>  89 
<a name='L90'>  90   <a href='../S/168.html#L181' title='Defined at 181 in src/threads/interrupt.c.'>intr_register_ext</a> (0x20 + 4, <a href='../S/142.html#L210' title='Defined at 210 in src/devices/serial.c.'>serial_interrupt</a>, "serial");
<a name='L91'>  91   mode = <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>QUEUE</a>;
<a name='L92'>  92   old_level = <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L93'>  93   <a href='../S/142.html#L177' title='Defined at 177 in src/devices/serial.c.'>write_ier</a> ();
<a name='L94'>  94   <a href='../S/168.html#L81' title='Defined at 81 in src/threads/interrupt.c.'>intr_set_level</a> (old_level);
<a name='L95'>  95 <font color='red'>}</font>
<a name='L96'>  96 
<a name='L97'>  97 <i><font color='green'>/* Sends BYTE to the serial port. */</font></i>
<a name='L98'>  98 <b>void</b>
<a name='L99'>  99 <a href='../R/801.html' title='Multiple refered from 2 places.'>serial_putc</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> byte) 
<a name='L100'> 100 <font color='red'>{</font>
<a name='L101'> 101   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level = <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L102'> 102 
<a name='L103'> 103   <b>if</b> (mode != <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>QUEUE</a>)
<a name='L104'> 104     <font color='red'>{</font>
<a name='L105'> 105       <i><font color='green'>/* If we're not set up for interrupt-driven I/O yet,</font></i>
<a name='L106'> 106 <i><font color='green'>         use dumb polling to transmit a byte. */</font></i>
<a name='L107'> 107       <b>if</b> (mode == <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>UNINIT</a>)
<a name='L108'> 108         <a href='../S/142.html#L67' title='Defined at 67 in src/devices/serial.c.'>init_poll</a> ();
<a name='L109'> 109       <a href='../S/142.html#L199' title='Defined at 199 in src/devices/serial.c.'>putc_poll</a> (byte); 
<a name='L110'> 110     <font color='red'>}</font>
<a name='L111'> 111   <b>else</b> 
<a name='L112'> 112     <font color='red'>{</font>
<a name='L113'> 113       <i><font color='green'>/* Otherwise, queue a byte and update the interrupt enable</font></i>
<a name='L114'> 114 <i><font color='green'>         register. */</font></i>
<a name='L115'> 115       <b>if</b> (old_level == INTR_OFF &amp;&amp; <a href='../S/135.html#L28' title='Defined at 28 in src/devices/intq.c.'>intq_full</a> (&amp;txq)) 
<a name='L116'> 116         <font color='red'>{</font>
<a name='L117'> 117           <i><font color='green'>/* Interrupts are off and the transmit queue is full.</font></i>
<a name='L118'> 118 <i><font color='green'>             If we wanted to wait for the queue to empty,</font></i>
<a name='L119'> 119 <i><font color='green'>             we'd have to reenable interrupts.</font></i>
<a name='L120'> 120 <i><font color='green'>             That's impolite, so we'll send a character via</font></i>
<a name='L121'> 121 <i><font color='green'>             polling instead. */</font></i>
<a name='L122'> 122           <a href='../S/142.html#L199' title='Defined at 199 in src/devices/serial.c.'>putc_poll</a> (<a href='../S/135.html#L38' title='Defined at 38 in src/devices/intq.c.'>intq_getc</a> (&amp;txq)); 
<a name='L123'> 123         <font color='red'>}</font>
<a name='L124'> 124 
<a name='L125'> 125       <a href='../S/135.html#L61' title='Defined at 61 in src/devices/intq.c.'>intq_putc</a> (&amp;txq, byte); 
<a name='L126'> 126       <a href='../S/142.html#L177' title='Defined at 177 in src/devices/serial.c.'>write_ier</a> ();
<a name='L127'> 127     <font color='red'>}</font>
<a name='L128'> 128   
<a name='L129'> 129   <a href='../S/168.html#L81' title='Defined at 81 in src/threads/interrupt.c.'>intr_set_level</a> (old_level);
<a name='L130'> 130 <font color='red'>}</font>
<a name='L131'> 131 
<a name='L132'> 132 <i><font color='green'>/* Flushes anything in the serial buffer out the port in polling</font></i>
<a name='L133'> 133 <i><font color='green'>   mode. */</font></i>
<a name='L134'> 134 <b>void</b>
<a name='L135'> 135 <a href='../R/797.html' title='Multiple refered from 3 places.'>serial_flush</a> (<b>void</b>) 
<a name='L136'> 136 <font color='red'>{</font>
<a name='L137'> 137   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level = <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L138'> 138   <b>while</b> (!<a href='../S/135.html#L20' title='Defined at 20 in src/devices/intq.c.'>intq_empty</a> (&amp;txq))
<a name='L139'> 139     <a href='../S/142.html#L199' title='Defined at 199 in src/devices/serial.c.'>putc_poll</a> (<a href='../S/135.html#L38' title='Defined at 38 in src/devices/intq.c.'>intq_getc</a> (&amp;txq));
<a name='L140'> 140   <a href='../S/168.html#L81' title='Defined at 81 in src/threads/interrupt.c.'>intr_set_level</a> (old_level);
<a name='L141'> 141 <font color='red'>}</font>
<a name='L142'> 142 
<a name='L143'> 143 <i><font color='green'>/* The fullness of the input buffer may have changed.  Reassess</font></i>
<a name='L144'> 144 <i><font color='green'>   whether we should block receive interrupts.</font></i>
<a name='L145'> 145 <i><font color='green'>   Called by the input buffer routines when characters are added</font></i>
<a name='L146'> 146 <i><font color='green'>   to or removed from the buffer. */</font></i>
<a name='L147'> 147 <b>void</b>
<a name='L148'> 148 <a href='../R/800.html' title='Multiple refered from 3 places.'>serial_notify</a> (<b>void</b>) 
<a name='L149'> 149 <font color='red'>{</font>
<a name='L150'> 150   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L151'> 151   <b>if</b> (mode == <a href='../S/142.html#L52' title='Defined at 52 in src/devices/serial.c.'>QUEUE</a>)
<a name='L152'> 152     <a href='../S/142.html#L177' title='Defined at 177 in src/devices/serial.c.'>write_ier</a> ();
<a name='L153'> 153 <font color='red'>}</font>
<a name='L154'> 154 
<a name='L155'> 155 <i><font color='green'>/* Configures the serial port for BPS bits per second. */</font></i>
<a name='L156'> 156 <b>static</b> <b>void</b>
<a name='L157'> 157 <a href='../R/802.html' title='Multiple refered from 2 places.'>set_serial</a> (<b>int</b> bps)
<a name='L158'> 158 <font color='red'>{</font>
<a name='L159'> 159   <b>int</b> base_rate = 1843200 / 16;         <i><font color='green'>/* Base rate of 16550A, in Hz. */</font></i>
<a name='L160'> 160   <a href='../S/87.html#L23' title='Defined at 23 in src/lib/stdint.h.'>uint16_t</a> divisor = base_rate / bps;   <i><font color='green'>/* Clock rate divisor. */</font></i>
<a name='L161'> 161 
<a name='L162'> 162   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (bps &gt;= 300 &amp;&amp; bps &lt;= 115200);
<a name='L163'> 163 
<a name='L164'> 164   <i><font color='green'>/* Enable DLAB. */</font></i>
<a name='L165'> 165   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L32' title='Defined at 32 in src/devices/serial.c.'>LCR_REG</a>, <a href='../S/142.html#L41' title='Defined at 41 in src/devices/serial.c.'>LCR_N81</a> | <a href='../S/142.html#L42' title='Defined at 42 in src/devices/serial.c.'>LCR_DLAB</a>);
<a name='L166'> 166 
<a name='L167'> 167   <i><font color='green'>/* Set data rate. */</font></i>
<a name='L168'> 168   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L26' title='Defined at 26 in src/devices/serial.c.'>LS_REG</a>, divisor &amp; 0xff);
<a name='L169'> 169   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L27' title='Defined at 27 in src/devices/serial.c.'>MS_REG</a>, divisor &gt;&gt; 8);
<a name='L170'> 170   
<a name='L171'> 171   <i><font color='green'>/* Reset DLAB. */</font></i>
<a name='L172'> 172   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L32' title='Defined at 32 in src/devices/serial.c.'>LCR_REG</a>, <a href='../S/142.html#L41' title='Defined at 41 in src/devices/serial.c.'>LCR_N81</a>);
<a name='L173'> 173 <font color='red'>}</font>
<a name='L174'> 174 
<a name='L175'> 175 <i><font color='green'>/* Update interrupt enable register. */</font></i>
<a name='L176'> 176 <b>static</b> <b>void</b>
<a name='L177'> 177 <a href='../R/977.html' title='Multiple refered from 5 places.'>write_ier</a> (<b>void</b>) 
<a name='L178'> 178 <font color='red'>{</font>
<a name='L179'> 179   <a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> ier = 0;
<a name='L180'> 180 
<a name='L181'> 181   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L182'> 182 
<a name='L183'> 183   <i><font color='green'>/* Enable transmit interrupt if we have any characters to</font></i>
<a name='L184'> 184 <i><font color='green'>     transmit. */</font></i>
<a name='L185'> 185   <b>if</b> (!<a href='../S/135.html#L20' title='Defined at 20 in src/devices/intq.c.'>intq_empty</a> (&amp;txq))
<a name='L186'> 186     ier |= <a href='../S/142.html#L38' title='Defined at 38 in src/devices/serial.c.'>IER_XMIT</a>;
<a name='L187'> 187 
<a name='L188'> 188   <i><font color='green'>/* Enable receive interrupt if we have room to store any</font></i>
<a name='L189'> 189 <i><font color='green'>     characters we receive. */</font></i>
<a name='L190'> 190   <b>if</b> (!<a href='../S/133.html#L48' title='Defined at 48 in src/devices/input.c.'>input_full</a> ())
<a name='L191'> 191     ier |= <a href='../S/142.html#L37' title='Defined at 37 in src/devices/serial.c.'>IER_RECV</a>;
<a name='L192'> 192   
<a name='L193'> 193   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L23' title='Defined at 23 in src/devices/serial.c.'>IER_REG</a>, ier);
<a name='L194'> 194 <font color='red'>}</font>
<a name='L195'> 195 
<a name='L196'> 196 <i><font color='green'>/* Polls the serial port until it's ready,</font></i>
<a name='L197'> 197 <i><font color='green'>   and then transmits BYTE. */</font></i>
<a name='L198'> 198 <b>static</b> <b>void</b>
<a name='L199'> 199 <a href='../R/742.html' title='Multiple refered from 4 places.'>putc_poll</a> (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> byte) 
<a name='L200'> 200 <font color='red'>{</font>
<a name='L201'> 201   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L202'> 202 
<a name='L203'> 203   <b>while</b> ((<a href='../S/157.html#L9' title='Defined at 9 in src/threads/io.h.'>inb</a> (<a href='../S/142.html#L34' title='Defined at 34 in src/devices/serial.c.'>LSR_REG</a>) &amp; <a href='../S/142.html#L49' title='Defined at 49 in src/devices/serial.c.'>LSR_THRE</a>) == 0)
<a name='L204'> 204     <b>continue</b>;
<a name='L205'> 205   <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L22' title='Defined at 22 in src/devices/serial.c.'>THR_REG</a>, byte);
<a name='L206'> 206 <font color='red'>}</font>
<a name='L207'> 207 
<a name='L208'> 208 <i><font color='green'>/* Serial interrupt handler. */</font></i>
<a name='L209'> 209 <b>static</b> <b>void</b>
<a name='L210'> 210 <a href='../R/799.html' title='Multiple refered from 2 places.'>serial_interrupt</a> (<b>struct</b> intr_frame *f <a href='../S/104.html#L7' title='Defined at 7 in src/lib/debug.h.'>UNUSED</a>) 
<a name='L211'> 211 <font color='red'>{</font>
<a name='L212'> 212   <i><font color='green'>/* Inquire about interrupt in UART.  Without this, we can</font></i>
<a name='L213'> 213 <i><font color='green'>     occasionally miss an interrupt running under QEMU. */</font></i>
<a name='L214'> 214   <a href='../S/157.html#L9' title='Defined at 9 in src/threads/io.h.'>inb</a> (<a href='../S/142.html#L30' title='Defined at 30 in src/devices/serial.c.'>IIR_REG</a>);
<a name='L215'> 215 
<a name='L216'> 216   <i><font color='green'>/* As long as we have room to receive a byte, and the hardware</font></i>
<a name='L217'> 217 <i><font color='green'>     has a byte for us, receive a byte.  */</font></i>
<a name='L218'> 218   <b>while</b> (!<a href='../S/133.html#L48' title='Defined at 48 in src/devices/input.c.'>input_full</a> () &amp;&amp; (<a href='../S/157.html#L9' title='Defined at 9 in src/threads/io.h.'>inb</a> (<a href='../S/142.html#L34' title='Defined at 34 in src/devices/serial.c.'>LSR_REG</a>) &amp; <a href='../S/142.html#L48' title='Defined at 48 in src/devices/serial.c.'>LSR_DR</a>) != 0)
<a name='L219'> 219     <a href='../S/133.html#L19' title='Defined at 19 in src/devices/input.c.'>input_putc</a> (<a href='../S/157.html#L9' title='Defined at 9 in src/threads/io.h.'>inb</a> (<a href='../S/142.html#L21' title='Defined at 21 in src/devices/serial.c.'>RBR_REG</a>));
<a name='L220'> 220 
<a name='L221'> 221   <i><font color='green'>/* As long as we have a byte to transmit, and the hardware is</font></i>
<a name='L222'> 222 <i><font color='green'>     ready to accept a byte for transmission, transmit a byte. */</font></i>
<a name='L223'> 223   <b>while</b> (!<a href='../S/135.html#L20' title='Defined at 20 in src/devices/intq.c.'>intq_empty</a> (&amp;txq) &amp;&amp; (<a href='../S/157.html#L9' title='Defined at 9 in src/threads/io.h.'>inb</a> (<a href='../S/142.html#L34' title='Defined at 34 in src/devices/serial.c.'>LSR_REG</a>) &amp; <a href='../S/142.html#L49' title='Defined at 49 in src/devices/serial.c.'>LSR_THRE</a>) != 0) 
<a name='L224'> 224     <a href='../S/157.html#L66' title='Defined at 66 in src/threads/io.h.'>outb</a> (<a href='../S/142.html#L22' title='Defined at 22 in src/devices/serial.c.'>THR_REG</a>, <a href='../S/135.html#L38' title='Defined at 38 in src/devices/intq.c.'>intq_getc</a> (&amp;txq));
<a name='L225'> 225 
<a name='L226'> 226   <i><font color='green'>/* Update interrupt enable register based on queue status. */</font></i>
<a name='L227'> 227   <a href='../S/142.html#L177' title='Defined at 177 in src/devices/serial.c.'>write_ier</a> ();
<a name='L228'> 228 <font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L67'>[^]</a><a href='#L210'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
