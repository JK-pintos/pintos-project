<html>
<head>
<title>src/threads/thread.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.7.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/595.html'>src</a>/<a href='../files/611.html'>threads</a>/thread.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L68'>[^]</a><a href='#L573'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L68' title='Defined at 68.'>is_thread</a>
<li><a href='#L106' title='Defined at 106.'>thread_start</a>
<li><a href='#L123' title='Defined at 123.'>thread_tick</a>
<li><a href='#L144' title='Defined at 144.'>thread_print_stats</a>
<li><a href='#L166' title='Defined at 166.'>thread_create</a>
<li><a href='#L222' title='Defined at 222.'>thread_block</a>
<li><a href='#L240' title='Defined at 240.'>thread_unblock</a>
<li><a href='#L255' title='Defined at 255.'>thread_name</a>
<li><a href='#L264' title='Defined at 264.'>thread_current</a>
<li><a href='#L281' title='Defined at 281.'>thread_tid</a>
<li><a href='#L289' title='Defined at 289.'>thread_exit</a>
<li><a href='#L310' title='Defined at 310.'>thread_yield</a>
<li><a href='#L328' title='Defined at 328.'>thread_foreach</a>
<li><a href='#L344' title='Defined at 344.'>thread_set_priority</a>
<li><a href='#L351' title='Defined at 351.'>thread_get_priority</a>
<li><a href='#L358' title='Defined at 358.'>thread_set_nice</a>
<li><a href='#L365' title='Defined at 365.'>thread_get_nice</a>
<li><a href='#L373' title='Defined at 373.'>thread_get_load_avg</a>
<li><a href='#L381' title='Defined at 381.'>thread_get_recent_cpu</a>
<li><a href='#L397' title='Defined at 397.'>idle</a>
<li><a href='#L427' title='Defined at 427.'>kernel_thread</a>
<li><a href='#L438' title='Defined at 438.'>running_thread</a>
<li><a href='#L452' title='Defined at 452.'>is_thread</a>
<li><a href='#L460' title='Defined at 460.'>init_thread</a>
<li><a href='#L478' title='Defined at 478.'>alloc_frame</a>
<li><a href='#L494' title='Defined at 494.'>next_thread_to_run</a>
<li><a href='#L519' title='Defined at 519.'>thread_schedule_tail</a>
<li><a href='#L556' title='Defined at 556.'>schedule</a>
<li><a href='#L573' title='Defined at 573.'>allocate_tid</a>
</ol>
<hr>
<pre>
<a name='L1'>   1 <font color='darkred'>#include</font> "<a href='164.html'>threads/thread.h</a>"
<a name='L2'>   2 <font color='darkred'>#include</font> &lt;<a href='104.html'>debug.h</a>&gt;
<a name='L3'>   3 <font color='darkred'>#include</font> &lt;<a href='92.html'>stddef.h</a>&gt;
<a name='L4'>   4 <font color='darkred'>#include</font> &lt;<a href='102.html'>random.h</a>&gt;
<a name='L5'>   5 <font color='darkred'>#include</font> &lt;<a href='../I/72.html'>stdio.h</a>&gt;
<a name='L6'>   6 <font color='darkred'>#include</font> &lt;<a href='82.html'>string.h</a>&gt;
<a name='L7'>   7 <font color='darkred'>#include</font> "<a href='145.html'>threads/flags.h</a>"
<a name='L8'>   8 <font color='darkred'>#include</font> "<a href='150.html'>threads/interrupt.h</a>"
<a name='L9'>   9 <font color='darkred'>#include</font> "<a href='166.html'>threads/intr-stubs.h</a>"
<a name='L10'>  10 <font color='darkred'>#include</font> "<a href='165.html'>threads/palloc.h</a>"
<a name='L11'>  11 <font color='darkred'>#include</font> "<a href='146.html'>threads/switch.h</a>"
<a name='L12'>  12 <font color='darkred'>#include</font> "<a href='155.html'>threads/synch.h</a>"
<a name='L13'>  13 <font color='darkred'>#include</font> "<a href='153.html'>threads/vaddr.h</a>"
<a name='L14'>  14 <font color='darkred'>#ifdef</font> USERPROG
<a name='L15'>  15 <font color='darkred'>#include</font> "<a href='63.html'>userprog/process.h</a>"
<a name='L16'>  16 <font color='darkred'>#endif</font>
<a name='L17'>  17 
<a name='L18'>  18 <i><font color='green'>/* Random value for struct thread's `magic' member.</font></i>
<a name='L19'>  19 <i><font color='green'>   Used to detect stack overflow.  See the big comment at the top</font></i>
<a name='L20'>  20 <i><font color='green'>   of thread.h for details. */</font></i>
<a name='L21'>  21 <font color='darkred'>#define</font> <a href='../R/231.html' title='Multiple refered from 2 places.'>THREAD_MAGIC</a> 0xcd6abf4b
<a name='L22'>  22 
<a name='L23'>  23 <i><font color='green'>/* List of processes in THREAD_READY state, that is, processes</font></i>
<a name='L24'>  24 <i><font color='green'>   that are ready to run but not actually running. */</font></i>
<a name='L25'>  25 <b>static</b> <b>struct</b> <a href='../S/107.html#L97' title='Defined at 97 in src/lib/kernel/list.h.'>list</a> ready_list;
<a name='L26'>  26 
<a name='L27'>  27 <i><font color='green'>/* List of all processes.  Processes are added to this list</font></i>
<a name='L28'>  28 <i><font color='green'>   when they are first scheduled and removed when they exit. */</font></i>
<a name='L29'>  29 <b>static</b> <b>struct</b> <a href='../S/107.html#L97' title='Defined at 97 in src/lib/kernel/list.h.'>list</a> all_list;
<a name='L30'>  30 
<a name='L31'>  31 <i><font color='green'>/* Idle thread. */</font></i>
<a name='L32'>  32 <b>static</b> <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *idle_thread;
<a name='L33'>  33 
<a name='L34'>  34 <i><font color='green'>/* Initial thread, the thread running init.c:main(). */</font></i>
<a name='L35'>  35 <b>static</b> <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *initial_thread;
<a name='L36'>  36 
<a name='L37'>  37 <i><font color='green'>/* Lock used by allocate_tid(). */</font></i>
<a name='L38'>  38 <b>static</b> <b>struct</b> <a href='../S/155.html#L21' title='Defined at 21 in src/threads/synch.h.'>lock</a> tid_lock;
<a name='L39'>  39 
<a name='L40'>  40 <i><font color='green'>/* Stack frame for kernel_thread(). */</font></i>
<a name='L41'>  41 <b>struct</b> <a href='../S/163.html#L170' title='Refered from 170 in src/threads/thread.c.'>kernel_thread_frame</a> 
<a name='L42'>  42   <font color='red'>{</font>
<a name='L43'>  43     <b>void</b> *eip;                  <i><font color='green'>/* Return address. */</font></i>
<a name='L44'>  44     <a href='../S/164.html#L116' title='Defined at 116 in src/threads/thread.h.'>thread_func</a> *function;      <i><font color='green'>/* Function to call. */</font></i>
<a name='L45'>  45     <b>void</b> *aux;                  <i><font color='green'>/* Auxiliary data for function. */</font></i>
<a name='L46'>  46   <font color='red'>}</font>;
<a name='L47'>  47 
<a name='L48'>  48 <i><font color='green'>/* Statistics. */</font></i>
<a name='L49'>  49 <b>static</b> <b>long</b> <b>long</b> idle_ticks;    <i><font color='green'>/* # of timer ticks spent idle. */</font></i>
<a name='L50'>  50 <b>static</b> <b>long</b> <b>long</b> kernel_ticks;  <i><font color='green'>/* # of timer ticks in kernel threads. */</font></i>
<a name='L51'>  51 <b>static</b> <b>long</b> <b>long</b> user_ticks;    <i><font color='green'>/* # of timer ticks in user programs. */</font></i>
<a name='L52'>  52 
<a name='L53'>  53 <i><font color='green'>/* Scheduling. */</font></i>
<a name='L54'>  54 <font color='darkred'>#define</font> <a href='../S/163.html#L138' title='Refered from 138 in src/threads/thread.c.'>TIME_SLICE</a> 4            <i><font color='green'>/* # of timer ticks to give each thread. */</font></i>
<a name='L55'>  55 <b>static</b> <b>unsigned</b> thread_ticks;   <i><font color='green'>/* # of timer ticks since last yield. */</font></i>
<a name='L56'>  56 
<a name='L57'>  57 <i><font color='green'>/* If false (default), use round-robin scheduler.</font></i>
<a name='L58'>  58 <i><font color='green'>   If true, use multi-level feedback queue scheduler.</font></i>
<a name='L59'>  59 <i><font color='green'>   Controlled by kernel command-line option "-o mlfqs". */</font></i>
<a name='L60'>  60 <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a> thread_mlfqs;
<a name='L61'>  61 
<a name='L62'>  62 <b>static</b> <b>void</b> <a href='../S/163.html#L427' title='Defined at 427 in src/threads/thread.c.'>kernel_thread</a> (thread_func *, <b>void</b> *aux);
<a name='L63'>  63 
<a name='L64'>  64 <b>static</b> <b>void</b> <a href='../S/163.html#L397' title='Defined at 397 in src/threads/thread.c.'>idle</a> (<b>void</b> *aux <a href='../S/104.html#L7' title='Defined at 7 in src/lib/debug.h.'>UNUSED</a>);
<a name='L65'>  65 <b>static</b> <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *<a href='../S/163.html#L438' title='Defined at 438 in src/threads/thread.c.'>running_thread</a> (<b>void</b>);
<a name='L66'>  66 <b>static</b> <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *<a href='../S/163.html#L494' title='Defined at 494 in src/threads/thread.c.'>next_thread_to_run</a> (<b>void</b>);
<a name='L67'>  67 <b>static</b> <b>void</b> <a href='../S/163.html#L460' title='Defined at 460 in src/threads/thread.c.'>init_thread</a> (<b>struct</b> thread *, <b>const</b> <b>char</b> *name, <b>int</b> priority);
<a name='L68'>  68 <b>static</b> <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a> <a href='../R/569.html' title='Multiple refered from 4 places.'>is_thread</a> (<b>struct</b> thread *) <a href='../S/104.html#L7' title='Defined at 7 in src/lib/debug.h.'>UNUSED</a>;
<a name='L69'>  69 <b>static</b> <b>void</b> *alloc_frame (<b>struct</b> thread *, <a href='../S/92.html#L10' title='Defined at 10 in src/lib/stddef.h.'>size_t</a> size);
<a name='L70'>  70 <b>static</b> <b>void</b> schedule (<b>void</b>);
<a name='L71'>  71 <b>void</b> thread_schedule_tail (<b>struct</b> thread *prev);
<a name='L72'>  72 <b>static</b> <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a> allocate_tid (<b>void</b>);
<a name='L73'>  73 
<a name='L74'>  74 <i><font color='green'>/* Initializes the threading system by transforming the code</font></i>
<a name='L75'>  75 <i><font color='green'>   that's currently running into a thread.  This can't work in</font></i>
<a name='L76'>  76 <i><font color='green'>   general and it is possible in this case only because loader.S</font></i>
<a name='L77'>  77 <i><font color='green'>   was careful to put the bottom of the stack at a page boundary.</font></i>
<a name='L78'>  78 <i><font color='green'></font></i>
<a name='L79'>  79 <i><font color='green'>   Also initializes the run queue and the tid lock.</font></i>
<a name='L80'>  80 <i><font color='green'></font></i>
<a name='L81'>  81 <i><font color='green'>   After calling this function, be sure to initialize the page</font></i>
<a name='L82'>  82 <i><font color='green'>   allocator before trying to create any threads with</font></i>
<a name='L83'>  83 <i><font color='green'>   thread_create().</font></i>
<a name='L84'>  84 <i><font color='green'></font></i>
<a name='L85'>  85 <i><font color='green'>   It is not safe to call thread_current() until this function</font></i>
<a name='L86'>  86 <i><font color='green'>   finishes. */</font></i>
<a name='L87'>  87 <b>void</b>
<a name='L88'>  88 thread_init (<b>void</b>) 
<a name='L89'>  89 <font color='red'>{</font>
<a name='L90'>  90   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L91'>  91 
<a name='L92'>  92   <a href='../S/167.html#L176' title='Defined at 176 in src/threads/synch.c.'>lock_init</a> (&amp;tid_lock);
<a name='L93'>  93   <a href='../S/112.html#L61' title='Defined at 61 in src/lib/kernel/list.c.'>list_init</a> (&amp;ready_list);
<a name='L94'>  94   <a href='../S/112.html#L61' title='Defined at 61 in src/lib/kernel/list.c.'>list_init</a> (&amp;all_list);
<a name='L95'>  95 
<a name='L96'>  96   <i><font color='green'>/* Set up a thread structure for the running thread. */</font></i>
<a name='L97'>  97   initial_thread = <a href='../S/163.html#L438' title='Defined at 438 in src/threads/thread.c.'>running_thread</a> ();
<a name='L98'>  98   <a href='../S/163.html#L460' title='Defined at 460 in src/threads/thread.c.'>init_thread</a> (initial_thread, "main", <a href='../S/164.html#L24' title='Defined at 24 in src/threads/thread.h.'>PRI_DEFAULT</a>);
<a name='L99'>  99   initial_thread-&gt;status = THREAD_RUNNING;
<a name='L100'> 100   initial_thread-&gt;tid = <a href='../S/163.html#L573' title='Defined at 573 in src/threads/thread.c.'>allocate_tid</a> ();
<a name='L101'> 101 <font color='red'>}</font>
<a name='L102'> 102 
<a name='L103'> 103 <i><font color='green'>/* Starts preemptive thread scheduling by enabling interrupts.</font></i>
<a name='L104'> 104 <i><font color='green'>   Also creates the idle thread. */</font></i>
<a name='L105'> 105 <b>void</b>
<a name='L106'> 106 <a href='../R/903.html' title='Multiple refered from 2 places.'>thread_start</a> (<b>void</b>) 
<a name='L107'> 107 <font color='red'>{</font>
<a name='L108'> 108   <i><font color='green'>/* Create the idle thread. */</font></i>
<a name='L109'> 109   <b>struct</b> <a href='../S/155.html#L8' title='Defined at 8 in src/threads/synch.h.'>semaphore</a> idle_started;
<a name='L110'> 110   <a href='../S/167.html#L45' title='Defined at 45 in src/threads/synch.c.'>sema_init</a> (&amp;idle_started, 0);
<a name='L111'> 111   <a href='../S/163.html#L166' title='Defined at 166 in src/threads/thread.c.'>thread_create</a> ("idle", <a href='../S/164.html#L23' title='Defined at 23 in src/threads/thread.h.'>PRI_MIN</a>, <a href='../S/163.html#L397' title='Defined at 397 in src/threads/thread.c.'>idle</a>, &amp;idle_started);
<a name='L112'> 112 
<a name='L113'> 113   <i><font color='green'>/* Start preemptive thread scheduling. */</font></i>
<a name='L114'> 114   <a href='../S/168.html#L88' title='Defined at 88 in src/threads/interrupt.c.'>intr_enable</a> ();
<a name='L115'> 115 
<a name='L116'> 116   <i><font color='green'>/* Wait for the idle thread to initialize idle_thread. */</font></i>
<a name='L117'> 117   <a href='../S/167.html#L61' title='Defined at 61 in src/threads/synch.c.'>sema_down</a> (&amp;idle_started);
<a name='L118'> 118 <font color='red'>}</font>
<a name='L119'> 119 
<a name='L120'> 120 <i><font color='green'>/* Called by the timer interrupt handler at each timer tick.</font></i>
<a name='L121'> 121 <i><font color='green'>   Thus, this function runs in an external interrupt context. */</font></i>
<a name='L122'> 122 <b>void</b>
<a name='L123'> 123 <a href='../R/905.html' title='Multiple refered from 2 places.'>thread_tick</a> (<b>void</b>) 
<a name='L124'> 124 <font color='red'>{</font>
<a name='L125'> 125   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *t = <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ();
<a name='L126'> 126 
<a name='L127'> 127   <i><font color='green'>/* Update statistics. */</font></i>
<a name='L128'> 128   <b>if</b> (t == idle_thread)
<a name='L129'> 129     idle_ticks++;
<a name='L130'> 130 <font color='darkred'>#ifdef</font> USERPROG
<a name='L131'> 131   <b>else</b> <b>if</b> (t-&gt;pagedir != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>)
<a name='L132'> 132     user_ticks++;
<a name='L133'> 133 <font color='darkred'>#endif</font>
<a name='L134'> 134   <b>else</b>
<a name='L135'> 135     kernel_ticks++;
<a name='L136'> 136 
<a name='L137'> 137   <i><font color='green'>/* Enforce preemption. */</font></i>
<a name='L138'> 138   <b>if</b> (++thread_ticks &gt;= <a href='../S/163.html#L54' title='Defined at 54 in src/threads/thread.c.'>TIME_SLICE</a>)
<a name='L139'> 139     <a href='../S/168.html#L222' title='Defined at 222 in src/threads/interrupt.c.'>intr_yield_on_return</a> ();
<a name='L140'> 140 <font color='red'>}</font>
<a name='L141'> 141 
<a name='L142'> 142 <i><font color='green'>/* Prints thread statistics. */</font></i>
<a name='L143'> 143 <b>void</b>
<a name='L144'> 144 <a href='../R/899.html' title='Multiple refered from 2 places.'>thread_print_stats</a> (<b>void</b>) 
<a name='L145'> 145 <font color='red'>{</font>
<a name='L146'> 146   <a href='../S/115.html#L79' title='Defined at 79 in src/lib/stdio.c.'>printf</a> ("Thread: %lld idle ticks, %lld kernel ticks, %lld user ticks\n",
<a name='L147'> 147           idle_ticks, kernel_ticks, user_ticks);
<a name='L148'> 148 <font color='red'>}</font>
<a name='L149'> 149 
<a name='L150'> 150 <i><font color='green'>/* Creates a new kernel thread named NAME with the given initial</font></i>
<a name='L151'> 151 <i><font color='green'>   PRIORITY, which executes FUNCTION passing AUX as the argument,</font></i>
<a name='L152'> 152 <i><font color='green'>   and adds it to the ready queue.  Returns the thread identifier</font></i>
<a name='L153'> 153 <i><font color='green'>   for the new thread, or TID_ERROR if creation fails.</font></i>
<a name='L154'> 154 <i><font color='green'></font></i>
<a name='L155'> 155 <i><font color='green'>   If thread_start() has been called, then the new thread may be</font></i>
<a name='L156'> 156 <i><font color='green'>   scheduled before thread_create() returns.  It could even exit</font></i>
<a name='L157'> 157 <i><font color='green'>   before thread_create() returns.  Contrariwise, the original</font></i>
<a name='L158'> 158 <i><font color='green'>   thread may run for any amount of time before the new thread is</font></i>
<a name='L159'> 159 <i><font color='green'>   scheduled.  Use a semaphore or some other form of</font></i>
<a name='L160'> 160 <i><font color='green'>   synchronization if you need to ensure ordering.</font></i>
<a name='L161'> 161 <i><font color='green'></font></i>
<a name='L162'> 162 <i><font color='green'>   The code provided sets the new thread's `priority' member to</font></i>
<a name='L163'> 163 <i><font color='green'>   PRIORITY, but no actual priority scheduling is implemented.</font></i>
<a name='L164'> 164 <i><font color='green'>   Priority scheduling is the goal of Problem 1-3. */</font></i>
<a name='L165'> 165 <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a>
<a name='L166'> 166 <a href='../R/889.html' title='Multiple refered from 31 places.'>thread_create</a> (<b>const</b> <b>char</b> *name, <b>int</b> priority,
<a name='L167'> 167                thread_func *function, <b>void</b> *aux) 
<a name='L168'> 168 <font color='red'>{</font>
<a name='L169'> 169   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *t;
<a name='L170'> 170   <b>struct</b> <a href='../S/163.html#L41' title='Defined at 41 in src/threads/thread.c.'>kernel_thread_frame</a> *kf;
<a name='L171'> 171   <b>struct</b> <a href='../S/146.html#L23' title='Defined at 23 in src/threads/switch.h.'>switch_entry_frame</a> *ef;
<a name='L172'> 172   <b>struct</b> <a href='../S/146.html#L6' title='Defined at 6 in src/threads/switch.h.'>switch_threads_frame</a> *sf;
<a name='L173'> 173   <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a> tid;
<a name='L174'> 174   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level;
<a name='L175'> 175 
<a name='L176'> 176   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (function != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L177'> 177 
<a name='L178'> 178   <i><font color='green'>/* Allocate thread. */</font></i>
<a name='L179'> 179   t = <a href='../S/160.html#L111' title='Defined at 111 in src/threads/palloc.c.'>palloc_get_page</a> (PAL_ZERO);
<a name='L180'> 180   <b>if</b> (t == <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>)
<a name='L181'> 181     <b>return</b> <a href='../S/164.html#L20' title='Defined at 20 in src/threads/thread.h.'>TID_ERROR</a>;
<a name='L182'> 182 
<a name='L183'> 183   <i><font color='green'>/* Initialize thread. */</font></i>
<a name='L184'> 184   <a href='../S/163.html#L460' title='Defined at 460 in src/threads/thread.c.'>init_thread</a> (t, name, priority);
<a name='L185'> 185   tid = t-&gt;tid = <a href='../S/163.html#L573' title='Defined at 573 in src/threads/thread.c.'>allocate_tid</a> ();
<a name='L186'> 186 
<a name='L187'> 187   <i><font color='green'>/* Prepare thread for first run by initializing its stack.</font></i>
<a name='L188'> 188 <i><font color='green'>     Do this atomically so intermediate values for the 'stack' </font></i>
<a name='L189'> 189 <i><font color='green'>     member cannot be observed. */</font></i>
<a name='L190'> 190   old_level = <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L191'> 191 
<a name='L192'> 192   <i><font color='green'>/* Stack frame for kernel_thread(). */</font></i>
<a name='L193'> 193   kf = <a href='../S/163.html#L478' title='Defined at 478 in src/threads/thread.c.'>alloc_frame</a> (t, <b>sizeof</b> *kf);
<a name='L194'> 194   kf-&gt;eip = <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>;
<a name='L195'> 195   kf-&gt;function = function;
<a name='L196'> 196   kf-&gt;aux = aux;
<a name='L197'> 197 
<a name='L198'> 198   <i><font color='green'>/* Stack frame for switch_entry(). */</font></i>
<a name='L199'> 199   ef = <a href='../S/163.html#L478' title='Defined at 478 in src/threads/thread.c.'>alloc_frame</a> (t, <b>sizeof</b> *ef);
<a name='L200'> 200   ef-&gt;eip = (<b>void</b> (*) (<b>void</b>)) <a href='../S/163.html#L427' title='Defined at 427 in src/threads/thread.c.'>kernel_thread</a>;
<a name='L201'> 201 
<a name='L202'> 202   <i><font color='green'>/* Stack frame for switch_threads(). */</font></i>
<a name='L203'> 203   sf = <a href='../S/163.html#L478' title='Defined at 478 in src/threads/thread.c.'>alloc_frame</a> (t, <b>sizeof</b> *sf);
<a name='L204'> 204   sf-&gt;eip = switch_entry;
<a name='L205'> 205   sf-&gt;ebp = 0;
<a name='L206'> 206 
<a name='L207'> 207   <a href='../S/168.html#L81' title='Defined at 81 in src/threads/interrupt.c.'>intr_set_level</a> (old_level);
<a name='L208'> 208 
<a name='L209'> 209   <i><font color='green'>/* Add to run queue. */</font></i>
<a name='L210'> 210   <a href='../S/163.html#L240' title='Defined at 240 in src/threads/thread.c.'>thread_unblock</a> (t);
<a name='L211'> 211 
<a name='L212'> 212   <b>return</b> tid;
<a name='L213'> 213 <font color='red'>}</font>
<a name='L214'> 214 
<a name='L215'> 215 <i><font color='green'>/* Puts the current thread to sleep.  It will not be scheduled</font></i>
<a name='L216'> 216 <i><font color='green'>   again until awoken by thread_unblock().</font></i>
<a name='L217'> 217 <i><font color='green'></font></i>
<a name='L218'> 218 <i><font color='green'>   This function must be called with interrupts turned off.  It</font></i>
<a name='L219'> 219 <i><font color='green'>   is usually a better idea to use one of the synchronization</font></i>
<a name='L220'> 220 <i><font color='green'>   primitives in synch.h. */</font></i>
<a name='L221'> 221 <b>void</b>
<a name='L222'> 222 <a href='../R/888.html' title='Multiple refered from 4 places.'>thread_block</a> (<b>void</b>) 
<a name='L223'> 223 <font color='red'>{</font>
<a name='L224'> 224   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (!<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L225'> 225   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L226'> 226 
<a name='L227'> 227   <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ()-&gt;status = THREAD_BLOCKED;
<a name='L228'> 228   <a href='../S/163.html#L556' title='Defined at 556 in src/threads/thread.c.'>schedule</a> ();
<a name='L229'> 229 <font color='red'>}</font>
<a name='L230'> 230 
<a name='L231'> 231 <i><font color='green'>/* Transitions a blocked thread T to the ready-to-run state.</font></i>
<a name='L232'> 232 <i><font color='green'>   This is an error if T is not blocked.  (Use thread_yield() to</font></i>
<a name='L233'> 233 <i><font color='green'>   make the running thread ready.)</font></i>
<a name='L234'> 234 <i><font color='green'></font></i>
<a name='L235'> 235 <i><font color='green'>   This function does not preempt the running thread.  This can</font></i>
<a name='L236'> 236 <i><font color='green'>   be important: if the caller had disabled interrupts itself,</font></i>
<a name='L237'> 237 <i><font color='green'>   it may expect that it can atomically unblock a thread and</font></i>
<a name='L238'> 238 <i><font color='green'>   update other data. */</font></i>
<a name='L239'> 239 <b>void</b>
<a name='L240'> 240 <a href='../R/907.html' title='Multiple refered from 4 places.'>thread_unblock</a> (<b>struct</b> thread *t) 
<a name='L241'> 241 <font color='red'>{</font>
<a name='L242'> 242   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level;
<a name='L243'> 243 
<a name='L244'> 244   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../D/665.html' title='Multiple defined in 2 places.'>is_thread</a> (t));
<a name='L245'> 245 
<a name='L246'> 246   old_level = <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L247'> 247   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (t-&gt;status == THREAD_BLOCKED);
<a name='L248'> 248   <a href='../S/112.html#L217' title='Defined at 217 in src/lib/kernel/list.c.'>list_push_back</a> (&amp;ready_list, &amp;t-&gt;elem);
<a name='L249'> 249   t-&gt;status = THREAD_READY;
<a name='L250'> 250   <a href='../S/168.html#L81' title='Defined at 81 in src/threads/interrupt.c.'>intr_set_level</a> (old_level);
<a name='L251'> 251 <font color='red'>}</font>
<a name='L252'> 252 
<a name='L253'> 253 <i><font color='green'>/* Returns the name of the running thread. */</font></i>
<a name='L254'> 254 <b>const</b> <b>char</b> *
<a name='L255'> 255 <a href='../R/898.html' title='Multiple refered from 15 places.'>thread_name</a> (<b>void</b>) 
<a name='L256'> 256 <font color='red'>{</font>
<a name='L257'> 257   <b>return</b> <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ()-&gt;name;
<a name='L258'> 258 <font color='red'>}</font>
<a name='L259'> 259 
<a name='L260'> 260 <i><font color='green'>/* Returns the running thread.</font></i>
<a name='L261'> 261 <i><font color='green'>   This is running_thread() plus a couple of sanity checks.</font></i>
<a name='L262'> 262 <i><font color='green'>   See the big comment at the top of thread.h for details. */</font></i>
<a name='L263'> 263 <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *
<a name='L264'> 264 <a href='../R/890.html' title='Multiple refered from 22 places.'>thread_current</a> (<b>void</b>) 
<a name='L265'> 265 <font color='red'>{</font>
<a name='L266'> 266   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *t = <a href='../S/163.html#L438' title='Defined at 438 in src/threads/thread.c.'>running_thread</a> ();
<a name='L267'> 267   
<a name='L268'> 268   <i><font color='green'>/* Make sure T is really a thread.</font></i>
<a name='L269'> 269 <i><font color='green'>     If either of these assertions fire, then your thread may</font></i>
<a name='L270'> 270 <i><font color='green'>     have overflowed its stack.  Each thread has less than 4 kB</font></i>
<a name='L271'> 271 <i><font color='green'>     of stack, so a few big automatic arrays or moderate</font></i>
<a name='L272'> 272 <i><font color='green'>     recursion can cause stack overflow. */</font></i>
<a name='L273'> 273   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../D/665.html' title='Multiple defined in 2 places.'>is_thread</a> (t));
<a name='L274'> 274   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (t-&gt;status == THREAD_RUNNING);
<a name='L275'> 275 
<a name='L276'> 276   <b>return</b> t;
<a name='L277'> 277 <font color='red'>}</font>
<a name='L278'> 278 
<a name='L279'> 279 <i><font color='green'>/* Returns the running thread's tid. */</font></i>
<a name='L280'> 280 <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a>
<a name='L281'> 281 <a href='../S/164.html#L123' title='Refered from 123 in src/threads/thread.h.'>thread_tid</a> (<b>void</b>) 
<a name='L282'> 282 <font color='red'>{</font>
<a name='L283'> 283   <b>return</b> <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ()-&gt;tid;
<a name='L284'> 284 <font color='red'>}</font>
<a name='L285'> 285 
<a name='L286'> 286 <i><font color='green'>/* Deschedules the current thread and destroys it.  Never</font></i>
<a name='L287'> 287 <i><font color='green'>   returns to the caller. */</font></i>
<a name='L288'> 288 <b>void</b>
<a name='L289'> 289 <a href='../R/891.html' title='Multiple refered from 7 places.'>thread_exit</a> (<b>void</b>) 
<a name='L290'> 290 <font color='red'>{</font>
<a name='L291'> 291   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (!<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L292'> 292 
<a name='L293'> 293 <font color='darkred'>#ifdef</font> USERPROG
<a name='L294'> 294   <a href='../S/66.html#L96' title='Defined at 96 in src/userprog/process.c.'>process_exit</a> ();
<a name='L295'> 295 <font color='darkred'>#endif</font>
<a name='L296'> 296 
<a name='L297'> 297   <i><font color='green'>/* Remove thread from all threads list, set our status to dying,</font></i>
<a name='L298'> 298 <i><font color='green'>     and schedule another process.  That process will destroy us</font></i>
<a name='L299'> 299 <i><font color='green'>     when it calls thread_schedule_tail(). */</font></i>
<a name='L300'> 300   <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L301'> 301   <a href='../S/112.html#L249' title='Defined at 249 in src/lib/kernel/list.c.'>list_remove</a> (&amp;<a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a>()-&gt;allelem);
<a name='L302'> 302   <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ()-&gt;status = THREAD_DYING;
<a name='L303'> 303   <a href='../S/163.html#L556' title='Defined at 556 in src/threads/thread.c.'>schedule</a> ();
<a name='L304'> 304   <a href='../D/135.html' title='Multiple defined in 2 places.'>NOT_REACHED</a> ();
<a name='L305'> 305 <font color='red'>}</font>
<a name='L306'> 306 
<a name='L307'> 307 <i><font color='green'>/* Yields the CPU.  The current thread is not put to sleep and</font></i>
<a name='L308'> 308 <i><font color='green'>   may be scheduled again immediately at the scheduler's whim. */</font></i>
<a name='L309'> 309 <b>void</b>
<a name='L310'> 310 <a href='../R/908.html' title='Multiple refered from 10 places.'>thread_yield</a> (<b>void</b>) 
<a name='L311'> 311 <font color='red'>{</font>
<a name='L312'> 312   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *cur = <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ();
<a name='L313'> 313   <b>enum</b> <a href='../S/150.html#L8' title='Defined at 8 in src/threads/interrupt.h.'>intr_level</a> old_level;
<a name='L314'> 314   
<a name='L315'> 315   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (!<a href='../S/168.html#L212' title='Defined at 212 in src/threads/interrupt.c.'>intr_context</a> ());
<a name='L316'> 316 
<a name='L317'> 317   old_level = <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L318'> 318   <b>if</b> (cur != idle_thread) 
<a name='L319'> 319     <a href='../S/112.html#L217' title='Defined at 217 in src/lib/kernel/list.c.'>list_push_back</a> (&amp;ready_list, &amp;cur-&gt;elem);
<a name='L320'> 320   cur-&gt;status = THREAD_READY;
<a name='L321'> 321   <a href='../S/163.html#L556' title='Defined at 556 in src/threads/thread.c.'>schedule</a> ();
<a name='L322'> 322   <a href='../S/168.html#L81' title='Defined at 81 in src/threads/interrupt.c.'>intr_set_level</a> (old_level);
<a name='L323'> 323 <font color='red'>}</font>
<a name='L324'> 324 
<a name='L325'> 325 <i><font color='green'>/* Invoke function 'func' on all threads, passing along 'aux'.</font></i>
<a name='L326'> 326 <i><font color='green'>   This function must be called with interrupts off. */</font></i>
<a name='L327'> 327 <b>void</b>
<a name='L328'> 328 <a href='../S/109.html#L121' title='Refered from 121 in src/lib/kernel/debug.c.'>thread_foreach</a> (thread_action_func *func, <b>void</b> *aux)
<a name='L329'> 329 <font color='red'>{</font>
<a name='L330'> 330   <b>struct</b> <a href='../S/107.html#L90' title='Defined at 90 in src/lib/kernel/list.h.'>list_elem</a> *e;
<a name='L331'> 331 
<a name='L332'> 332   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L333'> 333 
<a name='L334'> 334   <b>for</b> (e = <a href='../S/112.html#L72' title='Defined at 72 in src/lib/kernel/list.c.'>list_begin</a> (&amp;all_list); e != <a href='../S/112.html#L94' title='Defined at 94 in src/lib/kernel/list.c.'>list_end</a> (&amp;all_list);
<a name='L335'> 335        e = <a href='../S/112.html#L82' title='Defined at 82 in src/lib/kernel/list.c.'>list_next</a> (e))
<a name='L336'> 336     <font color='red'>{</font>
<a name='L337'> 337       <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *t = <a href='../S/107.html#L108' title='Defined at 108 in src/lib/kernel/list.h.'>list_entry</a> (e, <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a>, allelem);
<a name='L338'> 338       func (t, aux);
<a name='L339'> 339     <font color='red'>}</font>
<a name='L340'> 340 <font color='red'>}</font>
<a name='L341'> 341 
<a name='L342'> 342 <i><font color='green'>/* Sets the current thread's priority to NEW_PRIORITY. */</font></i>
<a name='L343'> 343 <b>void</b>
<a name='L344'> 344 <a href='../R/902.html' title='Multiple refered from 9 places.'>thread_set_priority</a> (<b>int</b> new_priority) 
<a name='L345'> 345 <font color='red'>{</font>
<a name='L346'> 346   <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ()-&gt;priority = new_priority;
<a name='L347'> 347 <font color='red'>}</font>
<a name='L348'> 348 
<a name='L349'> 349 <i><font color='green'>/* Returns the current thread's priority. */</font></i>
<a name='L350'> 350 <b>int</b>
<a name='L351'> 351 <a href='../R/895.html' title='Multiple refered from 29 places.'>thread_get_priority</a> (<b>void</b>) 
<a name='L352'> 352 <font color='red'>{</font>
<a name='L353'> 353   <b>return</b> <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ()-&gt;priority;
<a name='L354'> 354 <font color='red'>}</font>
<a name='L355'> 355 
<a name='L356'> 356 <i><font color='green'>/* Sets the current thread's nice value to NICE. */</font></i>
<a name='L357'> 357 <b>void</b>
<a name='L358'> 358 <a href='../R/901.html' title='Multiple refered from 4 places.'>thread_set_nice</a> (<b>int</b> nice <a href='../S/104.html#L7' title='Defined at 7 in src/lib/debug.h.'>UNUSED</a>) 
<a name='L359'> 359 <font color='red'>{</font>
<a name='L360'> 360   <i><font color='green'>/* Not yet implemented. */</font></i>
<a name='L361'> 361 <font color='red'>}</font>
<a name='L362'> 362 
<a name='L363'> 363 <i><font color='green'>/* Returns the current thread's nice value. */</font></i>
<a name='L364'> 364 <b>int</b>
<a name='L365'> 365 thread_get_nice (<b>void</b>) 
<a name='L366'> 366 <font color='red'>{</font>
<a name='L367'> 367   <i><font color='green'>/* Not yet implemented. */</font></i>
<a name='L368'> 368   <b>return</b> 0;
<a name='L369'> 369 <font color='red'>}</font>
<a name='L370'> 370 
<a name='L371'> 371 <i><font color='green'>/* Returns 100 times the system load average. */</font></i>
<a name='L372'> 372 <b>int</b>
<a name='L373'> 373 <a href='../R/894.html' title='Multiple refered from 5 places.'>thread_get_load_avg</a> (<b>void</b>) 
<a name='L374'> 374 <font color='red'>{</font>
<a name='L375'> 375   <i><font color='green'>/* Not yet implemented. */</font></i>
<a name='L376'> 376   <b>return</b> 0;
<a name='L377'> 377 <font color='red'>}</font>
<a name='L378'> 378 
<a name='L379'> 379 <i><font color='green'>/* Returns 100 times the current thread's recent_cpu value. */</font></i>
<a name='L380'> 380 <b>int</b>
<a name='L381'> 381 <a href='../R/896.html' title='Multiple refered from 2 places.'>thread_get_recent_cpu</a> (<b>void</b>) 
<a name='L382'> 382 <font color='red'>{</font>
<a name='L383'> 383   <i><font color='green'>/* Not yet implemented. */</font></i>
<a name='L384'> 384   <b>return</b> 0;
<a name='L385'> 385 <font color='red'>}</font>
<a name='L386'> 386 
<a name='L387'> 387 <i><font color='green'>/* Idle thread.  Executes when no other thread is ready to run.</font></i>
<a name='L388'> 388 <i><font color='green'></font></i>
<a name='L389'> 389 <i><font color='green'>   The idle thread is initially put on the ready list by</font></i>
<a name='L390'> 390 <i><font color='green'>   thread_start().  It will be scheduled once initially, at which</font></i>
<a name='L391'> 391 <i><font color='green'>   point it initializes idle_thread, "up"s the semaphore passed</font></i>
<a name='L392'> 392 <i><font color='green'>   to it to enable thread_start() to continue, and immediately</font></i>
<a name='L393'> 393 <i><font color='green'>   blocks.  After that, the idle thread never appears in the</font></i>
<a name='L394'> 394 <i><font color='green'>   ready list.  It is returned by next_thread_to_run() as a</font></i>
<a name='L395'> 395 <i><font color='green'>   special case when the ready list is empty. */</font></i>
<a name='L396'> 396 <b>static</b> <b>void</b>
<a name='L397'> 397 <a href='../R/502.html' title='Multiple refered from 2 places.'>idle</a> (<b>void</b> *idle_started_ <a href='../S/104.html#L7' title='Defined at 7 in src/lib/debug.h.'>UNUSED</a>) 
<a name='L398'> 398 <font color='red'>{</font>
<a name='L399'> 399   <b>struct</b> <a href='../S/155.html#L8' title='Defined at 8 in src/threads/synch.h.'>semaphore</a> *idle_started = idle_started_;
<a name='L400'> 400   idle_thread = <a href='../S/163.html#L264' title='Defined at 264 in src/threads/thread.c.'>thread_current</a> ();
<a name='L401'> 401   <a href='../S/167.html#L109' title='Defined at 109 in src/threads/synch.c.'>sema_up</a> (idle_started);
<a name='L402'> 402 
<a name='L403'> 403   <b>for</b> (;;) 
<a name='L404'> 404     <font color='red'>{</font>
<a name='L405'> 405       <i><font color='green'>/* Let someone else run. */</font></i>
<a name='L406'> 406       <a href='../S/168.html#L104' title='Defined at 104 in src/threads/interrupt.c.'>intr_disable</a> ();
<a name='L407'> 407       <a href='../S/163.html#L222' title='Defined at 222 in src/threads/thread.c.'>thread_block</a> ();
<a name='L408'> 408 
<a name='L409'> 409       <i><font color='green'>/* Re-enable interrupts and wait for the next one.</font></i>
<a name='L410'> 410 <i><font color='green'></font></i>
<a name='L411'> 411 <i><font color='green'>         The `sti' instruction disables interrupts until the</font></i>
<a name='L412'> 412 <i><font color='green'>         completion of the next instruction, so these two</font></i>
<a name='L413'> 413 <i><font color='green'>         instructions are executed atomically.  This atomicity is</font></i>
<a name='L414'> 414 <i><font color='green'>         important; otherwise, an interrupt could be handled</font></i>
<a name='L415'> 415 <i><font color='green'>         between re-enabling interrupts and waiting for the next</font></i>
<a name='L416'> 416 <i><font color='green'>         one to occur, wasting as much as one clock tick worth of</font></i>
<a name='L417'> 417 <i><font color='green'>         time.</font></i>
<a name='L418'> 418 <i><font color='green'></font></i>
<a name='L419'> 419 <i><font color='green'>         See [IA32-v2a] "HLT", [IA32-v2b] "STI", and [IA32-v3a]</font></i>
<a name='L420'> 420 <i><font color='green'>         7.11.1 "HLT Instruction". */</font></i>
<a name='L421'> 421       <b>asm</b> <b>volatile</b> ("sti; hlt" : : : "memory");
<a name='L422'> 422     <font color='red'>}</font>
<a name='L423'> 423 <font color='red'>}</font>
<a name='L424'> 424 
<a name='L425'> 425 <i><font color='green'>/* Function used as the basis for a kernel thread. */</font></i>
<a name='L426'> 426 <b>static</b> <b>void</b>
<a name='L427'> 427 <a href='../R/583.html' title='Multiple refered from 2 places.'>kernel_thread</a> (thread_func *function, <b>void</b> *aux) 
<a name='L428'> 428 <font color='red'>{</font>
<a name='L429'> 429   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (function != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L430'> 430 
<a name='L431'> 431   <a href='../S/168.html#L88' title='Defined at 88 in src/threads/interrupt.c.'>intr_enable</a> ();       <i><font color='green'>/* The scheduler runs with interrupts off. */</font></i>
<a name='L432'> 432   function (aux);       <i><font color='green'>/* Execute the thread function. */</font></i>
<a name='L433'> 433   <a href='../S/163.html#L289' title='Defined at 289 in src/threads/thread.c.'>thread_exit</a> ();       <i><font color='green'>/* If function() returns, kill the thread. */</font></i>
<a name='L434'> 434 <font color='red'>}</font>
<a name='L435'> 435 
<a name='L436'> 436 <i><font color='green'>/* Returns the running thread. */</font></i>
<a name='L437'> 437 <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *
<a name='L438'> 438 <a href='../R/781.html' title='Multiple refered from 5 places.'>running_thread</a> (<b>void</b>) 
<a name='L439'> 439 <font color='red'>{</font>
<a name='L440'> 440   <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> *esp;
<a name='L441'> 441 
<a name='L442'> 442   <i><font color='green'>/* Copy the CPU's stack pointer into `esp', and then round that</font></i>
<a name='L443'> 443 <i><font color='green'>     down to the start of a page.  Because `struct thread' is</font></i>
<a name='L444'> 444 <i><font color='green'>     always at the beginning of a page and the stack pointer is</font></i>
<a name='L445'> 445 <i><font color='green'>     somewhere in the middle, this locates the curent thread. */</font></i>
<a name='L446'> 446   <b>asm</b> ("mov %%esp, %0" : "=g" (esp));
<a name='L447'> 447   <b>return</b> <a href='../S/153.html#L39' title='Defined at 39 in src/threads/vaddr.h.'>pg_round_down</a> (esp);
<a name='L448'> 448 <font color='red'>}</font>
<a name='L449'> 449 
<a name='L450'> 450 <i><font color='green'>/* Returns true if T appears to point to a valid thread. */</font></i>
<a name='L451'> 451 <b>static</b> <a href='../S/78.html#L4' title='Defined at 4 in src/lib/stdbool.h.'>bool</a>
<a name='L452'> 452 <a href='../R/569.html' title='Multiple refered from 4 places.'>is_thread</a> (<b>struct</b> thread *t)
<a name='L453'> 453 <font color='red'>{</font>
<a name='L454'> 454   <b>return</b> t != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a> &amp;&amp; t-&gt;magic == <a href='../S/163.html#L21' title='Defined at 21 in src/threads/thread.c.'>THREAD_MAGIC</a>;
<a name='L455'> 455 <font color='red'>}</font>
<a name='L456'> 456 
<a name='L457'> 457 <i><font color='green'>/* Does basic initialization of T as a blocked thread named</font></i>
<a name='L458'> 458 <i><font color='green'>   NAME. */</font></i>
<a name='L459'> 459 <b>static</b> <b>void</b>
<a name='L460'> 460 <a href='../R/508.html' title='Multiple refered from 3 places.'>init_thread</a> (<b>struct</b> thread *t, <b>const</b> <b>char</b> *name, <b>int</b> priority)
<a name='L461'> 461 <font color='red'>{</font>
<a name='L462'> 462   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (t != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L463'> 463   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/164.html#L23' title='Defined at 23 in src/threads/thread.h.'>PRI_MIN</a> &lt;= priority &amp;&amp; priority &lt;= <a href='../S/164.html#L25' title='Defined at 25 in src/threads/thread.h.'>PRI_MAX</a>);
<a name='L464'> 464   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (name != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>);
<a name='L465'> 465 
<a name='L466'> 466   <a href='../S/83.html#L279' title='Defined at 279 in src/lib/string.c.'>memset</a> (t, 0, <b>sizeof</b> *t);
<a name='L467'> 467   t-&gt;status = THREAD_BLOCKED;
<a name='L468'> 468   <a href='../S/83.html#L326' title='Defined at 326 in src/lib/string.c.'>strlcpy</a> (t-&gt;name, name, <b>sizeof</b> t-&gt;name);
<a name='L469'> 469   t-&gt;stack = (<a href='../S/87.html#L20' title='Defined at 20 in src/lib/stdint.h.'>uint8_t</a> *) t + <a href='../S/153.html#L20' title='Defined at 20 in src/threads/vaddr.h.'>PGSIZE</a>;
<a name='L470'> 470   t-&gt;priority = priority;
<a name='L471'> 471   t-&gt;magic = <a href='../S/163.html#L21' title='Defined at 21 in src/threads/thread.c.'>THREAD_MAGIC</a>;
<a name='L472'> 472   <a href='../S/112.html#L217' title='Defined at 217 in src/lib/kernel/list.c.'>list_push_back</a> (&amp;all_list, &amp;t-&gt;allelem);
<a name='L473'> 473 <font color='red'>}</font>
<a name='L474'> 474 
<a name='L475'> 475 <i><font color='green'>/* Allocates a SIZE-byte frame at the top of thread T's stack and</font></i>
<a name='L476'> 476 <i><font color='green'>   returns a pointer to the frame's base. */</font></i>
<a name='L477'> 477 <b>static</b> <b>void</b> *
<a name='L478'> 478 <a href='../R/289.html' title='Multiple refered from 3 places.'>alloc_frame</a> (<b>struct</b> thread *t, <a href='../S/92.html#L10' title='Defined at 10 in src/lib/stddef.h.'>size_t</a> size) 
<a name='L479'> 479 <font color='red'>{</font>
<a name='L480'> 480   <i><font color='green'>/* Stack data is always allocated in word-size units. */</font></i>
<a name='L481'> 481   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../D/665.html' title='Multiple defined in 2 places.'>is_thread</a> (t));
<a name='L482'> 482   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (size % <b>sizeof</b> (<a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a>) == 0);
<a name='L483'> 483 
<a name='L484'> 484   t-&gt;stack -= size;
<a name='L485'> 485   <b>return</b> t-&gt;stack;
<a name='L486'> 486 <font color='red'>}</font>
<a name='L487'> 487 
<a name='L488'> 488 <i><font color='green'>/* Chooses and returns the next thread to be scheduled.  Should</font></i>
<a name='L489'> 489 <i><font color='green'>   return a thread from the run queue, unless the run queue is</font></i>
<a name='L490'> 490 <i><font color='green'>   empty.  (If the running thread can continue running, then it</font></i>
<a name='L491'> 491 <i><font color='green'>   will be in the run queue.)  If the run queue is empty, return</font></i>
<a name='L492'> 492 <i><font color='green'>   idle_thread. */</font></i>
<a name='L493'> 493 <b>static</b> <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *
<a name='L494'> 494 <a href='../R/670.html' title='Multiple refered from 2 places.'>next_thread_to_run</a> (<b>void</b>) 
<a name='L495'> 495 <font color='red'>{</font>
<a name='L496'> 496   <b>if</b> (<a href='../S/112.html#L310' title='Defined at 310 in src/lib/kernel/list.c.'>list_empty</a> (&amp;ready_list))
<a name='L497'> 497     <b>return</b> idle_thread;
<a name='L498'> 498   <b>else</b>
<a name='L499'> 499     <b>return</b> <a href='../S/107.html#L108' title='Defined at 108 in src/lib/kernel/list.h.'>list_entry</a> (<a href='../S/112.html#L260' title='Defined at 260 in src/lib/kernel/list.c.'>list_pop_front</a> (&amp;ready_list), <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a>, elem);
<a name='L500'> 500 <font color='red'>}</font>
<a name='L501'> 501 
<a name='L502'> 502 <i><font color='green'>/* Completes a thread switch by activating the new thread's page</font></i>
<a name='L503'> 503 <i><font color='green'>   tables, and, if the previous thread is dying, destroying it.</font></i>
<a name='L504'> 504 <i><font color='green'></font></i>
<a name='L505'> 505 <i><font color='green'>   At this function's invocation, we just switched from thread</font></i>
<a name='L506'> 506 <i><font color='green'>   PREV, the new thread is already running, and interrupts are</font></i>
<a name='L507'> 507 <i><font color='green'>   still disabled.  This function is normally invoked by</font></i>
<a name='L508'> 508 <i><font color='green'>   thread_schedule() as its final action before returning, but</font></i>
<a name='L509'> 509 <i><font color='green'>   the first time a thread is scheduled it is called by</font></i>
<a name='L510'> 510 <i><font color='green'>   switch_entry() (see switch.S).</font></i>
<a name='L511'> 511 <i><font color='green'></font></i>
<a name='L512'> 512 <i><font color='green'>   It's not safe to call printf() until the thread switch is</font></i>
<a name='L513'> 513 <i><font color='green'>   complete.  In practice that means that printf()s should be</font></i>
<a name='L514'> 514 <i><font color='green'>   added at the end of the function.</font></i>
<a name='L515'> 515 <i><font color='green'></font></i>
<a name='L516'> 516 <i><font color='green'>   After this function and its caller returns, the thread switch</font></i>
<a name='L517'> 517 <i><font color='green'>   is complete. */</font></i>
<a name='L518'> 518 <b>void</b>
<a name='L519'> 519 <a href='../S/163.html#L568' title='Refered from 568 in src/threads/thread.c.'>thread_schedule_tail</a> (<b>struct</b> thread *prev)
<a name='L520'> 520 <font color='red'>{</font>
<a name='L521'> 521   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *cur = <a href='../S/163.html#L438' title='Defined at 438 in src/threads/thread.c.'>running_thread</a> ();
<a name='L522'> 522   
<a name='L523'> 523   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L524'> 524 
<a name='L525'> 525   <i><font color='green'>/* Mark us as running. */</font></i>
<a name='L526'> 526   cur-&gt;status = THREAD_RUNNING;
<a name='L527'> 527 
<a name='L528'> 528   <i><font color='green'>/* Start new time slice. */</font></i>
<a name='L529'> 529   thread_ticks = 0;
<a name='L530'> 530 
<a name='L531'> 531 <font color='darkred'>#ifdef</font> USERPROG
<a name='L532'> 532   <i><font color='green'>/* Activate the new address space. */</font></i>
<a name='L533'> 533   <a href='../S/66.html#L123' title='Defined at 123 in src/userprog/process.c.'>process_activate</a> ();
<a name='L534'> 534 <font color='darkred'>#endif</font>
<a name='L535'> 535 
<a name='L536'> 536   <i><font color='green'>/* If the thread we switched from is dying, destroy its struct</font></i>
<a name='L537'> 537 <i><font color='green'>     thread.  This must happen late so that thread_exit() doesn't</font></i>
<a name='L538'> 538 <i><font color='green'>     pull out the rug under itself.  (We don't free</font></i>
<a name='L539'> 539 <i><font color='green'>     initial_thread because its memory was not obtained via</font></i>
<a name='L540'> 540 <i><font color='green'>     palloc().) */</font></i>
<a name='L541'> 541   <b>if</b> (prev != <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a> &amp;&amp; prev-&gt;status == THREAD_DYING &amp;&amp; prev != initial_thread) 
<a name='L542'> 542     <font color='red'>{</font>
<a name='L543'> 543       <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (prev != cur);
<a name='L544'> 544       <a href='../S/160.html#L146' title='Defined at 146 in src/threads/palloc.c.'>palloc_free_page</a> (prev);
<a name='L545'> 545     <font color='red'>}</font>
<a name='L546'> 546 <font color='red'>}</font>
<a name='L547'> 547 
<a name='L548'> 548 <i><font color='green'>/* Schedules a new process.  At entry, interrupts must be off and</font></i>
<a name='L549'> 549 <i><font color='green'>   the running process's state must have been changed from</font></i>
<a name='L550'> 550 <i><font color='green'>   running to some other state.  This function finds another</font></i>
<a name='L551'> 551 <i><font color='green'>   thread to run and switches to it.</font></i>
<a name='L552'> 552 <i><font color='green'></font></i>
<a name='L553'> 553 <i><font color='green'>   It's not safe to call printf() until thread_schedule_tail()</font></i>
<a name='L554'> 554 <i><font color='green'>   has completed. */</font></i>
<a name='L555'> 555 <b>static</b> <b>void</b>
<a name='L556'> 556 <a href='../R/782.html' title='Multiple refered from 3 places.'>schedule</a> (<b>void</b>) 
<a name='L557'> 557 <font color='red'>{</font>
<a name='L558'> 558   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *cur = <a href='../S/163.html#L438' title='Defined at 438 in src/threads/thread.c.'>running_thread</a> ();
<a name='L559'> 559   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *<a href='../S/135.html#L79' title='Defined at 79 in src/devices/intq.c.'>next</a> = <a href='../S/163.html#L494' title='Defined at 494 in src/threads/thread.c.'>next_thread_to_run</a> ();
<a name='L560'> 560   <b>struct</b> <a href='../S/164.html#L83' title='Defined at 83 in src/threads/thread.h.'>thread</a> *prev = <a href='../S/92.html#L4' title='Defined at 4 in src/lib/stddef.h.'>NULL</a>;
<a name='L561'> 561 
<a name='L562'> 562   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../S/168.html#L65' title='Defined at 65 in src/threads/interrupt.c.'>intr_get_level</a> () == INTR_OFF);
<a name='L563'> 563   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (cur-&gt;status != THREAD_RUNNING);
<a name='L564'> 564   <a href='../S/104.html#L37' title='Defined at 37 in src/lib/debug.h.'>ASSERT</a> (<a href='../D/665.html' title='Multiple defined in 2 places.'>is_thread</a> (<a href='../S/135.html#L79' title='Defined at 79 in src/devices/intq.c.'>next</a>));
<a name='L565'> 565 
<a name='L566'> 566   <b>if</b> (cur != <a href='../S/135.html#L79' title='Defined at 79 in src/devices/intq.c.'>next</a>)
<a name='L567'> 567     prev = switch_threads (cur, <a href='../S/135.html#L79' title='Defined at 79 in src/devices/intq.c.'>next</a>);
<a name='L568'> 568   <a href='../S/163.html#L519' title='Defined at 519 in src/threads/thread.c.'>thread_schedule_tail</a> (prev);
<a name='L569'> 569 <font color='red'>}</font>
<a name='L570'> 570 
<a name='L571'> 571 <i><font color='green'>/* Returns a tid to use for a new thread. */</font></i>
<a name='L572'> 572 <b>static</b> <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a>
<a name='L573'> 573 <a href='../R/290.html' title='Multiple refered from 2 places.'>allocate_tid</a> (<b>void</b>) 
<a name='L574'> 574 <font color='red'>{</font>
<a name='L575'> 575   <b>static</b> <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a> next_tid = 1;
<a name='L576'> 576   <a href='../S/164.html#L19' title='Defined at 19 in src/threads/thread.h.'>tid_t</a> tid;
<a name='L577'> 577 
<a name='L578'> 578   <a href='../S/167.html#L193' title='Defined at 193 in src/threads/synch.c.'>lock_acquire</a> (&amp;tid_lock);
<a name='L579'> 579   tid = next_tid++;
<a name='L580'> 580   <a href='../S/167.html#L229' title='Defined at 229 in src/threads/synch.c.'>lock_release</a> (&amp;tid_lock);
<a name='L581'> 581 
<a name='L582'> 582   <b>return</b> tid;
<a name='L583'> 583 <font color='red'>}</font>
<a name='L584'> 584 
<a name='L585'> 585 <i><font color='green'>/* Offset of `stack' member within `struct thread'.</font></i>
<a name='L586'> 586 <i><font color='green'>   Used by switch.S, which can't figure it out on its own. */</font></i>
<a name='L587'> 587 <a href='../S/87.html#L26' title='Defined at 26 in src/lib/stdint.h.'>uint32_t</a> thread_stack_ofs = <a href='../S/92.html#L5' title='Defined at 5 in src/lib/stddef.h.'>offsetof</a> (<b>struct</b> thread, stack);
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L68'>[^]</a><a href='#L573'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
